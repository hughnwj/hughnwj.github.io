<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="1. Agent概述 1.1 Agent开发当前尬尴的局面 1.2 Agent开发框架 1.3 学习Agent开发框架的8大要点 2. LangGraph 底层原理介绍2.1 LangGraph 的主要特点 模型兼容性广泛：支持 GPT 系列、GLM、LLaMA、Qwen 等主流在线与开源大模型。 接入方式灵活：支持传统 API 集成、也兼容 Ollama、vLLM 等推理加速工具。 Agent">
<meta property="og:type" content="article">
<meta property="og:title" content="11.Agent实战技能之LangGraph深度实战">
<meta property="og:url" content="http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="cozy">
<meta property="og:description" content="1. Agent概述 1.1 Agent开发当前尬尴的局面 1.2 Agent开发框架 1.3 学习Agent开发框架的8大要点 2. LangGraph 底层原理介绍2.1 LangGraph 的主要特点 模型兼容性广泛：支持 GPT 系列、GLM、LLaMA、Qwen 等主流在线与开源大模型。 接入方式灵活：支持传统 API 集成、也兼容 Ollama、vLLM 等推理加速工具。 Agent">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1.jpg">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2.jpg">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/3.jpg">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/4.jpg">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/5.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/image-20250411154233254.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1744362995058-5.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1744363814909-7.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2-1744364124508-9.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/3.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/5-1744608295214-1.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2-1744613634483-3.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/6.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1744619866364-6.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/a.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/b.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/a-1744965182810-1.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/b-1744965791891-3.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/d-1744965833176-5.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/g.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/h.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/i.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1745030623191-12.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2-1745030648400-14.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/3-1745031055730-16.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/4.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/5-1745052464875-19.png">
<meta property="og:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/6-1745052507580-21.png">
<meta property="article:published_time" content="2025-04-01T01:46:54.072Z">
<meta property="article:modified_time" content="2025-04-19T18:45:39.186Z">
<meta property="article:author" content="cozy">
<meta property="article:tag" content="工作">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>11.Agent实战技能之LangGraph深度实战</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/hughnwj">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2025/04/21/12.Agent%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%981%E7%99%BE%E4%BA%BF%E7%BA%A7%E6%99%BA%E8%83%BD%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%B9%B3%E5%8F%B0/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2025/03/24/10.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangChain%E5%85%A8%E9%9D%A2%E5%89%96%E6%9E%90/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&text=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&is_video=false&description=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=11.Agent实战技能之LangGraph深度实战&body=Check out this article: http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&name=11.Agent实战技能之LangGraph深度实战&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&t=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Agent%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">1. Agent概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Agent%E5%BC%80%E5%8F%91%E5%BD%93%E5%89%8D%E5%B0%AC%E5%B0%B4%E7%9A%84%E5%B1%80%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 Agent开发当前尬尴的局面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Agent%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 Agent开发框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%AD%A6%E4%B9%A0Agent%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6%E7%9A%848%E5%A4%A7%E8%A6%81%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 学习Agent开发框架的8大要点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-LangGraph-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">2. LangGraph 底层原理介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-LangGraph-%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E7%82%B9"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 LangGraph 的主要特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%B8%8E-LangChain-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 与 LangChain 的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%A0%B8%E5%BF%83%E4%BC%98%E5%8A%BF%E6%A6%82%E8%A7%88"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 核心优势概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E6%9C%BA%E5%88%B6"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 核心功能机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-LangGraph%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. LangGraph底层源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E7%AE%80%E5%8D%95Graph%E7%9A%84%E6%9E%84%E5%BB%BA"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 简单Graph的构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BD%BF%E7%94%A8LangGraph%E6%9E%84%E5%BB%BA%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%97%AE%E7%AD%94%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 使用LangGraph构建大模型的问答流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-State%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">4. State状态模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-State%E7%9A%84%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 State的定义模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Reducer%E5%87%BD%E6%95%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 Reducer函数机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MessageGraph-%E6%BA%90%E7%A0%81%E5%8A%9F%E8%83%BD%E8%A7%A3%E6%9E%90"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MessageGraph 源码功能解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-MessageGraph"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 MessageGraph</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-add-messages"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2  add_messages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-MessageGraph-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.3.3.</span> <span class="toc-text">4.3.3 MessageGraph 基本使用示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-4-add-messages-%E5%90%88%E5%B9%B6%E9%80%BB%E8%BE%91%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.3.4.</span> <span class="toc-text">4.3.4 add_messages 合并逻辑示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-5-MessageGraph-%E4%B8%8E-StateGraph-%E5%AF%B9%E6%AF%94"><span class="toc-number">4.3.5.</span> <span class="toc-text">4.3.5 MessageGraph 与 StateGraph 对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-StateGraph%E5%AE%9A%E4%B9%89%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 StateGraph定义聊天机器人</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-LangSmith"><span class="toc-number">5.</span> <span class="toc-text">5. LangSmith</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E5%8D%95%E4%BB%A3%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">6. 单代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E8%B7%AF%E7%94%B1%E4%BB%A3%E7%90%86"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 路由代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E6%9D%A1%E4%BB%B6%E8%BE%B9"><span class="toc-number">6.1.1.</span> <span class="toc-text">6.1.1 条件边</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA"><span class="toc-number">6.1.2.</span> <span class="toc-text">6.1.2 结构化输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E6%9E%84%E5%BB%BA%E8%B7%AF%E7%94%B1%E5%9B%BE"><span class="toc-number">6.1.3.</span> <span class="toc-text">6.1.3 构建路由图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E4%BB%A3%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 工具调用代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-ReAct"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 ReAct</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E4%BA%8B%E4%BB%B6%E6%B5%81"><span class="toc-number">7.</span> <span class="toc-text">7. 事件流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-LangChain%E4%BA%8B%E4%BB%B6%E6%B5%81"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 LangChain事件流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-LangGraph%E4%BA%8B%E4%BB%B6%E6%B5%81"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 LangGraph事件流</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E9%95%BF%E7%9F%AD%E6%9C%9F%E8%AE%B0%E5%BF%86"><span class="toc-number">8.</span> <span class="toc-text">8. 长短期记忆</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E7%8A%B6%E6%80%81%EF%BC%88State%EF%BC%89"><span class="toc-number">8.1.</span> <span class="toc-text">8.1 状态（State）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E8%AE%B0%E5%BF%86%E6%9C%BA%E5%88%B6"><span class="toc-number">8.2.</span> <span class="toc-text">8.2 记忆机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1-%E7%9F%AD%E6%9C%9F%E8%AE%B0%E5%BF%86%E4%B8%8E-Checkpointer%EF%BC%88%E6%A3%80%E6%9F%A5%E7%82%B9%EF%BC%89"><span class="toc-number">8.2.1.</span> <span class="toc-text">8.2.1 短期记忆与 Checkpointer（检查点）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-1-MemorySaver%EF%BC%88%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%EF%BC%8C%E9%80%82%E5%90%88%E5%AE%9E%E9%AA%8C%EF%BC%89"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">8.2.1.1 MemorySaver（内存存储，适合实验）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-2-SqliteSaver-AsyncSqliteSaver%EF%BC%88%E6%9C%AC%E5%9C%B0-SQLite-%E5%AD%98%E5%82%A8%EF%BC%89"><span class="toc-number">8.2.1.2.</span> <span class="toc-text">8.2.1.2 SqliteSaver &#x2F; AsyncSqliteSaver（本地 SQLite 存储）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-3-PostgresSaver-AsyncPostgresSaver%EF%BC%88%E7%94%9F%E4%BA%A7%E7%BA%A7%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%89"><span class="toc-number">8.2.1.3.</span> <span class="toc-text">8.1.2.3 PostgresSaver &#x2F; AsyncPostgresSaver（生产级持久化）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-4-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A3%80%E6%9F%A5%E7%82%B9%EF%BC%88Advanced%EF%BC%89"><span class="toc-number">8.2.1.4.</span> <span class="toc-text">8.1.2.4 自定义检查点（Advanced）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2-%E9%95%BF%E6%9C%9F%E8%AE%B0%E5%BF%86%E5%92%8CStore%EF%BC%88%E4%BB%93%E5%BA%93%EF%BC%89"><span class="toc-number">8.2.2.</span> <span class="toc-text">8.2.2 长期记忆和Store（仓库）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-Human-in-the-loop"><span class="toc-number">9.</span> <span class="toc-text">9. Human-in-the-loop</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E8%83%8C%E6%99%AF%E4%B8%8E%E9%9C%80%E6%B1%82"><span class="toc-number">9.1.</span> <span class="toc-text">9.1 背景与需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-HIL-%E5%B8%B8%E8%A7%81%E4%BA%A4%E4%BA%92%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.2.</span> <span class="toc-text">9.2 HIL 常见交互模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E5%9C%A8-LangGraph-%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">9.3.</span> <span class="toc-text">9.3 在 LangGraph 中的实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">9.4.</span> <span class="toc-text">9.4 代码示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-%E5%A4%9A%E8%BD%AE%E5%AF%B9%E8%AF%9D%E5%B0%81%E8%A3%85%E7%A4%BA%E4%BE%8B"><span class="toc-number">9.5.</span> <span class="toc-text">9.5 多轮对话封装示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-Multi-Agent-Systems"><span class="toc-number">10.</span> <span class="toc-text">10. Multi-Agent Systems</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-OpenAI%E5%AF%B9AI-Agent%E7%9A%84%E7%90%86%E8%A7%A3"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 OpenAI对AI Agent的理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-Single-Agent-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B1%80%E9%99%90"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 Single-Agent 架构的局限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-Multi-agent-architectures-%E6%9E%B6%E6%9E%84"><span class="toc-number">10.3.</span> <span class="toc-text">10.2 Multi-agent architectures 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-Subgraphs"><span class="toc-number">10.4.</span> <span class="toc-text">10.3 Subgraphs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E5%9F%BA%E4%BA%8E-Network-%EF%BC%88%E7%BD%91%E7%BB%9C%EF%BC%89%E7%9A%84%E5%A4%9A%E4%BB%A3%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">10.5.</span> <span class="toc-text">10.4 基于 Network （网络）的多代理架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-5-Supervisor-%E5%A4%9A%E4%BB%A3%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">10.6.</span> <span class="toc-text">10.5 Supervisor 多代理架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-1-Magentic-One"><span class="toc-number">10.6.1.</span> <span class="toc-text">10.5.1 Magentic-One</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-2-Supervisor-%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">10.6.2.</span> <span class="toc-text">10.5.2 Supervisor 架构介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-6-Multi-Agent%E5%AE%9E%E7%8E%B0%E6%B7%B7%E5%90%88%E5%A4%9A%E7%9F%A5%E8%AF%86%E5%BA%93%E6%A3%80%E7%B4%A2"><span class="toc-number">10.7.</span> <span class="toc-text">10.6 Multi-Agent实现混合多知识库检索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-1-GraphRAG-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">10.7.1.</span> <span class="toc-text">10.6.1 GraphRAG 基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-2-GraphRAG"><span class="toc-number">10.7.2.</span> <span class="toc-text">10.6.2 GraphRAG</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-3-%E4%BC%A0%E7%BB%9F-RAG-Agent"><span class="toc-number">10.7.3.</span> <span class="toc-text">10.6.3 传统 RAG Agent</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        11.Agent实战技能之LangGraph深度实战
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cozy</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-04-01T01:46:54.072Z" class="dt-published" itemprop="datePublished">2025-04-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/AI%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BC%80%E5%8F%91%E5%B7%A5%E7%A8%8B%E5%B8%88/">AI大模型开发工程师</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E5%B7%A5%E4%BD%9C/" rel="tag">工作</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="1-Agent概述"><a href="#1-Agent概述" class="headerlink" title="1. Agent概述"></a>1. Agent概述</h1><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1.jpg" alt="1"></p>
<h2 id="1-1-Agent开发当前尬尴的局面"><a href="#1-1-Agent开发当前尬尴的局面" class="headerlink" title="1.1 Agent开发当前尬尴的局面"></a>1.1 Agent开发当前尬尴的局面</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2.jpg" alt="2"></p>
<h2 id="1-2-Agent开发框架"><a href="#1-2-Agent开发框架" class="headerlink" title="1.2 Agent开发框架"></a>1.2 Agent开发框架</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/3.jpg" alt="3"></p>
<h2 id="1-3-学习Agent开发框架的8大要点"><a href="#1-3-学习Agent开发框架的8大要点" class="headerlink" title="1.3 学习Agent开发框架的8大要点"></a>1.3 学习Agent开发框架的8大要点</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/4.jpg" alt="4"></p>
<h1 id="2-LangGraph-底层原理介绍"><a href="#2-LangGraph-底层原理介绍" class="headerlink" title="2. LangGraph 底层原理介绍"></a>2. LangGraph 底层原理介绍</h1><h2 id="2-1-LangGraph-的主要特点"><a href="#2-1-LangGraph-的主要特点" class="headerlink" title="2.1 LangGraph 的主要特点"></a>2.1 LangGraph 的主要特点</h2><ul>
<li><strong>模型兼容性广泛</strong>：支持 GPT 系列、GLM、LLaMA、Qwen 等主流在线与开源大模型。</li>
<li><strong>接入方式灵活</strong>：支持传统 API 集成、也兼容 Ollama、vLLM 等推理加速工具。</li>
<li><strong>Agent 构建灵活</strong>：内置 ReAct 框架，支持扩展 Planning 等自定义策略。</li>
</ul>
<h2 id="2-2-与-LangChain-的关系"><a href="#2-2-与-LangChain-的关系" class="headerlink" title="2.2 与 LangChain 的关系"></a>2.2 与 LangChain 的关系</h2><ul>
<li>LangChain v0.3 开始采用表达式语言（LCEL），支持通过 DAG 构建链式任务。</li>
<li>LCEL 适用于线性流程，但不适合循环&#x2F;条件等复杂结构。</li>
<li>LangGraph 基于 LangChain 表达式语言，专为构建智能、可循环的 AI Agent 系统设计。</li>
<li>核心差异：<ul>
<li><strong>LangChain</strong>：关注链与工具，构建线性流程。</li>
<li><strong>LangGraph</strong>：强调循环图结构，支持状态管理与多步推理。</li>
</ul>
</li>
</ul>
<h2 id="2-3-核心优势概览"><a href="#2-3-核心优势概览" class="headerlink" title="2.3 核心优势概览"></a>2.3 核心优势概览</h2><ul>
<li><strong>循环与分支支持</strong>：原生支持复杂逻辑流程。</li>
<li><strong>状态持久化</strong>：图每一步自动保存状态，便于恢复。</li>
<li><strong>人机交互能力</strong>：可中断流程，支持人工干预。</li>
<li><strong>流式输出</strong>：支持逐 token 输出。</li>
<li><strong>无缝集成</strong>：与 LangChain&#x2F;LangSmith 完整兼容，但不依赖。</li>
</ul>
<h2 id="2-4-核心功能机制"><a href="#2-4-核心功能机制" class="headerlink" title="2.4 核心功能机制"></a>2.4 核心功能机制</h2><ul>
<li>LangGraph 使用 <strong>Nodes（节点）+ Edges（边）</strong> 构建图流程。</li>
<li>节点间通过 <strong>消息传递（Message）+ 状态（State）</strong> 协同工作。</li>
<li>每次执行中：<ul>
<li>节点处理输入 → 更新状态 → 决定下一个步骤。</li>
<li>状态动态变化，驱动循环与条件逻辑。</li>
</ul>
</li>
</ul>
<p>示意图如下：</p>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/5.png" alt="5"></p>
<blockquote>
<p><strong>什么是共享状态？</strong></p>
<ul>
<li><strong>共享状态</strong>：节点之间传递与共享的数据集合。</li>
<li>每个节点可基于共享状态读取、写入、更新数据。</li>
<li>有助于节点间协作、同步、做出决策。</li>
</ul>
</blockquote>
<h2 id="2-5-参考资料"><a href="#2-5-参考资料" class="headerlink" title="2.5 参考资料"></a>2.5 参考资料</h2><ul>
<li>GitHub: <a target="_blank" rel="noopener" href="https://github.com/langchain-ai/langgraph">LangGraph</a></li>
<li>文档站点: <a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/">LangGraph Docs</a></li>
</ul>
<h1 id="3-LangGraph底层源码解析"><a href="#3-LangGraph底层源码解析" class="headerlink" title="3. LangGraph底层源码解析"></a>3. LangGraph底层源码解析</h1><h2 id="3-1-简单Graph的构建"><a href="#3-1-简单Graph的构建" class="headerlink" title="3.1 简单Graph的构建"></a>3.1 简单Graph的构建</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> START, END</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义输入的模式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    question: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义输出的模式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutputState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    answer: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 InputState 和 OutputState 这两个 TypedDict 类型合并成一个更全面的字典类型。</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OverallState</span>(InputState, OutputState):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">agent_node</span>(<span class="params">state: InputState</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我是一个AI Agent。&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;question&quot;</span>: state[<span class="string">&quot;question&quot;</span>]&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">action_node</span>(<span class="params">state: InputState</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;我现在是一个执行者。&quot;</span>)</span><br><span class="line">    step = state[<span class="string">&quot;question&quot;</span>]</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;answer&quot;</span>: <span class="string">f&quot;我接收到的问题是：<span class="subst">&#123;step&#125;</span>，读取成功了！&quot;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 明确指定它的输入和输出数据的结构或模式</span></span><br><span class="line">builder = StateGraph(OverallState, <span class="built_in">input</span>=InputState, output=OutputState)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加节点</span></span><br><span class="line">builder.add_node(<span class="string">&quot;agent_node&quot;</span>, agent_node)</span><br><span class="line">builder.add_node(<span class="string">&quot;action_node&quot;</span>, action_node)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加边</span></span><br><span class="line">builder.add_edge(START, <span class="string">&quot;agent_node&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;agent_node&quot;</span>, <span class="string">&quot;action_node&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;action_node&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译图</span></span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line">graph.invoke(&#123;<span class="string">&quot;question&quot;</span>:<span class="string">&quot;今天的天气怎么样？&quot;</span>&#125;)</span><br><span class="line">graph.invoke(&#123;<span class="string">&quot;question&quot;</span>:<span class="string">&quot;你好，我用来测试&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="3-2-使用LangGraph构建大模型的问答流程"><a href="#3-2-使用LangGraph构建大模型的问答流程" class="headerlink" title="3.2 使用LangGraph构建大模型的问答流程"></a>3.2 使用LangGraph构建大模型的问答流程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> START, END</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 API 密钥</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置请求的基础地址</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义输入数据结构，包含问题字段</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InputState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    question: <span class="built_in">str</span></span><br><span class="line">    llm_answer: <span class="type">Optional</span>[<span class="built_in">str</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义输出数据结构，包含回答字段</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutputState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    answer: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义总体状态，结合输入与输出</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OverallState</span>(InputState, OutputState):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义处理问题的节点函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">llm_node</span>(<span class="params">state: InputState</span>):</span><br><span class="line">    messages = [</span><br><span class="line">        (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;你是一位乐于助人的智能小助理&quot;</span>,),</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, state[<span class="string">&quot;question&quot;</span>])</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>, )</span><br><span class="line">    response = llm.invoke(messages)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;llm_answer&quot;</span>: response.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义将内容翻译成英文的节点函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">action_node</span>(<span class="params">state: InputState</span>):</span><br><span class="line">    messages = [</span><br><span class="line">        (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;无论你接收到什么语言的文本，请翻译成英语&quot;</span>,),</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, state[<span class="string">&quot;llm_answer&quot;</span>])</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>, )</span><br><span class="line">    response = llm.invoke(messages)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;answer&quot;</span>: response.content&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建有状态图并指定输入输出结构</span></span><br><span class="line">builder = StateGraph(OverallState, <span class="built_in">input</span>=InputState, output=OutputState)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加图中处理节点</span></span><br><span class="line">builder.add_node(<span class="string">&quot;llm_node&quot;</span>, llm_node)</span><br><span class="line">builder.add_node(<span class="string">&quot;action_node&quot;</span>, action_node)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义节点之间的连接顺序</span></span><br><span class="line">builder.add_edge(START, <span class="string">&quot;llm_node&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;llm_node&quot;</span>, <span class="string">&quot;action_node&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;action_node&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译图结构</span></span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行图流程，输入第一个问题</span></span><br><span class="line">final_answer = graph.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;你好，请你详细的介绍一下你自己&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(final_answer[<span class="string">&quot;answer&quot;</span>])</span><br><span class="line"><span class="comment"># 输出：将对模型自身的中文介绍翻译成英文后的回答内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行图流程，输入第二个问题</span></span><br><span class="line">final_answer = graph.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;请问什么是人工智能？&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(final_answer[<span class="string">&quot;answer&quot;</span>])</span><br><span class="line"><span class="comment"># 输出：将关于人工智能的中文解释翻译成英文后的回答内容</span></span><br></pre></td></tr></table></figure>

<h1 id="4-State状态模式"><a href="#4-State状态模式" class="headerlink" title="4. State状态模式"></a>4. State状态模式</h1><h2 id="4-1-State的定义模式"><a href="#4-1-State的定义模式" class="headerlink" title="4.1 State的定义模式"></a>4.1 State的定义模式</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1.png" alt="1"></p>
<p>&emsp;&emsp;<code>LangGraph</code>构建的图中的每个节点都具备访问、读取和写入状态的权限。当某一个节点去修改状态时，它会将此信息广播到图中的所有其他节点。这种广播机制允许其他节点响应状态的变化并相应地调整其行为。如上图所示，从初始状态（Initial State）开始，其中包含了一条消息 { “x”: “10” }，随着消息在节点间通过边传递，每个节点根据其逻辑对状态进行更新。Node 1 和 Node 2 分别对状态进行了处理和变更，结果是在图的末端，我们得到了一个包含三条消息的最终状态 { “x”: “10” }, { “x”: “11” }, { “y”: “9” }。**从开发的角度来看，<code>State</code>实际上是一个共享的数据结构。如上图所示，状态表现为一个简单的字典。通过对这个字典进行读写操作，可以实现自左而右的数据流动，从而构建一个可运行的图结构。那么根据前面学习的内容，我们可以利用这个流程来复现并理解图中的动态数据交换，整体的设计如下：</p>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2.png" alt="2"></p>
<blockquote>
<p>可视化将任何<code>Graph</code>以图形的形式展示出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph(xray=<span class="literal">True</span>).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>

<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/image-20250411154233254.png" alt="image-20250411154233254"></p>
</blockquote>
<h2 id="4-2-Reducer函数机制"><a href="#4-2-Reducer函数机制" class="headerlink" title="4.2 Reducer函数机制"></a>4.2 Reducer函数机制</h2><p>&emsp;&emsp;<code>Reducer</code> 函数用来根据当前的状态（state）和一个操作（action）来计算并返回新的状态。它是一种设计模式，用于将业务逻辑与状态变更解耦，使得状态的变更预测性更强并且容易追踪。这样的函数通常接收两个参数：当前的状态（state）和一个描述应用了什么操作的对象（action）， 根据 <code>action</code> 类型来决定如何修改状态。比如，在一个购物车应用中，可能会有添加商品、删除商品、修改商品数量等操作。返回一个新的状态对象，而不是修改原始状态对象。<strong>简单理解，<code>Reducer</code>函数做的就是根据给定的输入（当前状态和操作）生成新的状态。</strong><code>LangGraph</code>中，如果没有显示的指定，则对该键的所有更新都执行的是覆盖操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated, TypedDict, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="type">List</span>[<span class="built_in">str</span>], operator.add]</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addition</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="built_in">print</span>(state)</span><br><span class="line">    msg = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>]</span><br><span class="line">    response = &#123;<span class="string">&quot;x&quot;</span>: msg[<span class="string">&quot;x&quot;</span>] + <span class="number">1</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">subtraction</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="built_in">print</span>(state)</span><br><span class="line">    msg = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>]</span><br><span class="line">    response = &#123;<span class="string">&quot;x&quot;</span>: msg[<span class="string">&quot;x&quot;</span>] - <span class="number">2</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 构建图</span></span><br><span class="line">builder = StateGraph(State) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 向图中添加两个节点</span></span><br><span class="line">builder.add_node(<span class="string">&quot;node1&quot;</span>, addition)</span><br><span class="line">builder.add_node(<span class="string">&quot;node2&quot;</span>, subtraction)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建节点之间的边</span></span><br><span class="line">builder.add_edge(START, <span class="string">&quot;node1&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;node1&quot;</span>, <span class="string">&quot;node2&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;node2&quot;</span>, END)</span><br><span class="line"></span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph(xray=<span class="literal">True</span>).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>messages：这是字典中的一个键，它表示某个字段（比如消息列表）。</li>
<li>List[str]：这是这个字段值的数据类型，它表示一个字符串类型的列表（即一个包含多个字符串的集合）。</li>
<li>Annotated[List[str], operator.add]：这是一个类型注解的特殊用法，它使用 Annotated 来附加额外的元数据（在这里是 operator.add）。Annotated 是 Python 3.9 引入的，它允许你在指定类型的同时附加额外的信息（例如，方法、操作符等）。</li>
<li>operator.add 是 Python 中的一个加法运算符，通常用来对数字进行加法操作。在这里，它作为元数据附加在 List[str] 类型后面，表明这个字段 messages 可能会涉及到某些与加法相关的操作，虽然这里并没有直接用到它。</li>
</ul>
</blockquote>
<p>&emsp;&emsp;<code>Reducer</code>机制的一个现实意义是：我们可以基于这种方式去构建历史对话记录。因为目前大多数大模型应用都是接受消息列表作为输入。 就像<code>LangChain</code>中的<code>Chat Model</code>，需要接收<code>Message</code>对象列表作为输入。这些消息有多种形式，例如HumanMessage （用户输入）或AIMessage （ 大模型响应）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated, TypedDict, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> SystemMessage, HumanMessage</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 API 密钥</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 API 的基础访问地址</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化大语言模型</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义图中的状态结构，messages 是字符串列表，使用 Annotated 加强语义</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="type">List</span>[<span class="built_in">str</span>], operator.add]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建有状态图对象</span></span><br><span class="line">builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义聊天节点的处理逻辑</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chat_with_model</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="built_in">print</span>(state)</span><br><span class="line">    <span class="comment"># 输出当前状态中传入的消息列表</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----------------&quot;</span>)</span><br><span class="line">    <span class="comment"># 输出分隔线用于标识流程阶段</span></span><br><span class="line"></span><br><span class="line">    messages = state[<span class="string">&#x27;messages&#x27;</span>]</span><br><span class="line">    response = llm.invoke(messages)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据转换节点的处理逻辑</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_messages</span>(<span class="params">state</span>):</span><br><span class="line">    EXTRACTION_PROMPT = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    You are a data extraction specialist tasked with retrieving key information from a text.</span></span><br><span class="line"><span class="string">    Extract such information for the provided text and output it in JSON format. Outline the key data points extracted.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(state)</span><br><span class="line">    <span class="comment"># 输出当前状态数据，主要包含 AI 回复</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----------------&quot;</span>)</span><br><span class="line">    <span class="comment"># 输出分隔线用于标识流程阶段</span></span><br><span class="line"></span><br><span class="line">    messages = [</span><br><span class="line">        SystemMessage(content=EXTRACTION_PROMPT),</span><br><span class="line">        HumanMessage(content=state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>].content)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    response = llm.invoke(messages)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加聊天与转换的两个处理节点</span></span><br><span class="line">builder.add_node(<span class="string">&quot;chat_with_model&quot;</span>, chat_with_model)</span><br><span class="line">builder.add_node(<span class="string">&quot;convert_messages&quot;</span>, convert_messages)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置流程起点</span></span><br><span class="line">builder.set_entry_point(<span class="string">&quot;chat_with_model&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义节点之间的连接顺序</span></span><br><span class="line">builder.add_edge(<span class="string">&quot;chat_with_model&quot;</span>, <span class="string">&quot;convert_messages&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;convert_messages&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译图结构</span></span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 渲染图结构并展示（仅 Jupyter 可视化）</span></span><br><span class="line">display(Image(graph.get_graph(xray=<span class="literal">True</span>).draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入初始消息</span></span><br><span class="line">query = <span class="string">&quot;你好，请你介绍一下你自己&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行图流程</span></span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># 输出：完整的图运行结果，包括 messages 列表中所有对话轮次的内容</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br><span class="line"><span class="comment"># 输出：最后一轮消息的内容，即提取后的英文结构化回复</span></span><br></pre></td></tr></table></figure>

<h2 id="4-3-MessageGraph-源码功能解析"><a href="#4-3-MessageGraph-源码功能解析" class="headerlink" title="4.3 MessageGraph 源码功能解析"></a>4.3 <code>MessageGraph</code> 源码功能解析</h2><h3 id="4-3-1-MessageGraph"><a href="#4-3-1-MessageGraph" class="headerlink" title="4.3.1 MessageGraph"></a>4.3.1 <code>MessageGraph</code></h3><ul>
<li><code>MessageGraph</code> 是 <code>StateGraph</code> 的子类，专注于处理基于消息的流程（如对话）。</li>
<li>状态定义为：<code>messages: Annotated[List[AnyMessage], add_messages]</code><ul>
<li>表示消息是一个可持续追加的列表。</li>
<li>每个节点接受消息列表作为输入，并返回一个或多个消息作为输出。</li>
</ul>
</li>
</ul>
<h3 id="4-3-2-add-messages"><a href="#4-3-2-add-messages" class="headerlink" title="4.3.2  add_messages"></a>4.3.2  <code>add_messages</code></h3><p>使用 <code>operator.add</code> 时：</p>
<ul>
<li>所有新消息会直接追加到已有消息后，不会更新已有消息内容。</li>
</ul>
<p>为了解决这个问题，<code>LangGraph</code> 提供了更高级的合并函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph.message <span class="keyword">import</span> add_messages</span><br></pre></td></tr></table></figure>

<p>优点如下：</p>
<ul>
<li>若消息 ID 不存在，则直接追加。</li>
<li>若消息 ID 已存在，则新消息会覆盖旧消息，实现更新。</li>
</ul>
<h3 id="4-3-3-MessageGraph-基本使用示例"><a href="#4-3-3-MessageGraph-基本使用示例" class="headerlink" title="4.3.3 MessageGraph 基本使用示例"></a>4.3.3 <code>MessageGraph</code> 基本使用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph.message <span class="keyword">import</span> MessageGraph</span><br><span class="line"></span><br><span class="line">builder = MessageGraph()</span><br><span class="line">builder.add_node(<span class="string">&quot;chatbot&quot;</span>, <span class="keyword">lambda</span> state: [(<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;你好，最帅气的人！&quot;</span>)])</span><br><span class="line">builder.set_entry_point(<span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">builder.set_finish_point(<span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(graph.invoke([(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;你好，请你介绍一下你自己.&quot;</span>)]))</span><br><span class="line"><span class="comment"># 输出：[(&quot;assistant&quot;, &quot;你好，最帅气的人！&quot;)]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(graph.invoke([(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;Hi 3213.&quot;</span>)]))</span><br><span class="line"><span class="comment"># 输出：[(&quot;assistant&quot;, &quot;你好，最帅气的人！&quot;)]</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-4-add-messages-合并逻辑示例"><a href="#4-3-4-add-messages-合并逻辑示例" class="headerlink" title="4.3.4 add_messages 合并逻辑示例"></a>4.3.4 <code>add_messages</code> 合并逻辑示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph.message <span class="keyword">import</span> add_messages</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> AIMessage, HumanMessage</span><br><span class="line"></span><br><span class="line">msgs1 = [HumanMessage(content=<span class="string">&quot;你好。&quot;</span>, <span class="built_in">id</span>=<span class="string">&quot;1&quot;</span>)]</span><br><span class="line">msgs2 = [AIMessage(content=<span class="string">&quot;你好，很高兴认识你。&quot;</span>, <span class="built_in">id</span>=<span class="string">&quot;2&quot;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add_messages(msgs1, msgs2))</span><br><span class="line"><span class="comment"># 输出：[HumanMessage(id=&quot;1&quot;), AIMessage(id=&quot;2&quot;)]</span></span><br><span class="line"></span><br><span class="line">msgs1 = [HumanMessage(content=<span class="string">&quot;你好。&quot;</span>, <span class="built_in">id</span>=<span class="string">&quot;1&quot;</span>)]</span><br><span class="line">msgs2 = [HumanMessage(content=<span class="string">&quot;你好呀。&quot;</span>, <span class="built_in">id</span>=<span class="string">&quot;1&quot;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add_messages(msgs1, msgs2))</span><br><span class="line"><span class="comment"># 输出：[HumanMessage(content=&quot;你好呀。&quot;, id=&quot;1&quot;)]</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li>若 ID 不同，新消息被追加；</li>
<li>若 ID 相同，新消息覆盖旧消息。</li>
</ul>
<h3 id="4-3-5-MessageGraph-与-StateGraph-对比"><a href="#4-3-5-MessageGraph-与-StateGraph-对比" class="headerlink" title="4.3.5 MessageGraph 与 StateGraph 对比"></a>4.3.5 <code>MessageGraph</code> 与 <code>StateGraph</code> 对比</h3><table>
<thead>
<tr>
<th>项目</th>
<th><code>MessageGraph</code></th>
<th><code>StateGraph</code></th>
</tr>
</thead>
<tbody><tr>
<td>主要用途</td>
<td>消息驱动对话流程</td>
<td>更通用的复杂状态处理流程</td>
</tr>
<tr>
<td>状态结构</td>
<td><code>List[Message]</code>，使用 <code>add_messages</code> 合并</td>
<td>自定义结构，如 <code>TypedDict</code> 或 Pydantic 等</td>
</tr>
<tr>
<td>输出内容</td>
<td>新的消息列表</td>
<td>任意类型状态数据</td>
</tr>
<tr>
<td>适用场景</td>
<td>聊天机器人、多轮对话</td>
<td>数据流转、任务编排、多步骤逻辑流程</td>
</tr>
</tbody></table>
<h2 id="4-4-StateGraph定义聊天机器人"><a href="#4-4-StateGraph定义聊天机器人" class="headerlink" title="4.4 StateGraph定义聊天机器人"></a>4.4 <code>StateGraph</code>定义聊天机器人</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化导入（按标准库、第三方库、本地库分组）</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, START, END</span><br><span class="line"><span class="keyword">from</span> langgraph.graph.message <span class="keyword">import</span> add_messages</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义状态类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>, add_messages]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化图构建器</span></span><br><span class="line">graph_builder = StateGraph(State)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置OpenAI参数</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chatbot</span>(<span class="params">state: State</span>):</span><br><span class="line">    <span class="comment"># 调用语言模型生成回复</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [llm.invoke(state[<span class="string">&quot;messages&quot;</span>])]&#125;</span><br><span class="line">    <span class="comment"># print(state)预测结果：打印整个state字典内容</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建对话图</span></span><br><span class="line">graph_builder.add_node(<span class="string">&quot;chatbot&quot;</span>, chatbot)</span><br><span class="line">graph_builder.add_edge(START, <span class="string">&quot;chatbot&quot;</span>)</span><br><span class="line">graph_builder.add_edge(<span class="string">&quot;chatbot&quot;</span>, END)</span><br><span class="line">graph = graph_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stream_graph_updates</span>(<span class="params">user_input: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="comment"># 流式处理对话图更新</span></span><br><span class="line">    <span class="keyword">for</span> event <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;messages&quot;</span>: [(<span class="string">&quot;user&quot;</span>, user_input)]&#125;):</span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> event.values():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;模型回复:&quot;</span>, value[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br><span class="line">            <span class="comment"># print预测结果：打印模型生成的最新回复内容</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主对话循环</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;用户提问: &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> user_input.lower() <span class="keyword">in</span> [<span class="string">&quot;退出&quot;</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;下次再见！&quot;</span>)</span><br><span class="line">            <span class="comment"># print预测结果：打印退出提示语</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        stream_graph_updates(user_input)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h1 id="5-LangSmith"><a href="#5-LangSmith" class="headerlink" title="5. LangSmith"></a>5. LangSmith</h1><p>&emsp;&emsp;大模型具有不确定性，尤其是构建复杂<code>AI Agent</code>应用程序中，中间会涉及非常多的子步骤，如果想要了解每一步的运行状态和结果，一方面可以通过<code>Debug</code>来进行实时控制，而另一方面可以借助一些工具来观察和调试中间的交互流程。<code>Langsmith</code>就是这样一个工具平台， 由 <code>LangChain</code> 和 <code>LangGraph</code> 背后的团队创建，<strong>主要作用是：为基于大语言模型构建的应用程序提供全面的监控、调试和可观察性。提供强大的跟踪、日志记录和实时分析功能。</strong></p>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1744362995058-5.png" alt="1"></p>
<ul>
<li><strong>Project (项目)</strong> 蓝色方块代表整个项目，可能是一个单独的应用程序或服务。</li>
<li><strong>Traces (轨迹)</strong> 绿色方块代表项目在不同条件或配置下的执行路径。每个轨迹可以是一个特定的用户会话、一个功能的执行，或者应用在特定输入下的行为。</li>
<li><strong>Runs (运行)</strong> 每个轨迹下的黄色方块表示特定轨迹的单次执行。这些是执行的实例，每个实例都是轨迹在特定条件下的实际运行。</li>
<li><strong>Feedback, Tags, Metadata (反馈、标签、元数据)</strong> 这部分显示了系统如何利用用户或自动化工具生成的反馈、标签和元数据来增强轨迹的管理和过滤。反馈可以用于改进未来的运行，标签和元数据可用于分类和筛选特定的轨迹或运行，以便在LangSmith的用户界面中更容易地管理和审查</li>
</ul>
<blockquote>
<p>LangSmith：<a target="_blank" rel="noopener" href="https://smith.langchain.com/">https://smith.langchain.com/</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 设置LangChain环境变量</span></span><br><span class="line">os.environ[<span class="string">&quot;LANGCHAIN_TRACING_V2&quot;</span>] = <span class="string">&quot;true&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;LANGCHAIN_API_KEY&quot;</span>] = <span class="string">&quot;your_LANGCHAIN_API_KEY&quot;</span></span><br><span class="line"><span class="comment"># os.environ[&quot;LANGCHAIN_PROJECT&quot;] = &quot;chat&quot;</span></span><br><span class="line"><span class="comment"># os.environ[&quot;LANGCHAIN_ENDPOINT&quot;] = &quot;https://api.smith.langchain.com&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="6-单代理"><a href="#6-单代理" class="headerlink" title="6. 单代理"></a>6. 单代理</h1><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1744363814909-7.png" alt="1"></p>
<ul>
<li>单代理<ul>
<li>路由代理</li>
<li>工具代理（tool）</li>
<li>自主循环代理（react）</li>
</ul>
</li>
<li>多代理（多agent）</li>
</ul>
<h2 id="6-1-路由代理"><a href="#6-1-路由代理" class="headerlink" title="6.1 路由代理"></a>6.1 路由代理</h2><h3 id="6-1-1-条件边"><a href="#6-1-1-条件边" class="headerlink" title="6.1.1 条件边"></a>6.1.1 条件边</h3><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2-1744364124508-9.png" alt="2"></p>
<p>&emsp;&emsp;在<code>LangGraph</code>中，我们可以利用“条件边”这一概念来指导或约束大模型在处理特定任务时的逻辑流程。这种机制允许大模型在达到某一环节并满足预设条件时，根据不同的条件输出或数据，选择性地执行不同的逻辑路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> START, StateGraph, END</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">node_a</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;x&quot;</span>: state[<span class="string">&quot;x&quot;</span>] + <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">node_b</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;x&quot;</span>: state[<span class="string">&quot;x&quot;</span>] - <span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">node_c</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;x&quot;</span>: state[<span class="string">&quot;x&quot;</span>] + <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">routing_function</span>():</span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;x&quot;</span>] == <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">builder = StateGraph(<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line">builder.add_node(<span class="string">&quot;node_a&quot;</span>, node_a)</span><br><span class="line">builder.add_node(<span class="string">&quot;node_b&quot;</span>, node_b)</span><br><span class="line">builder.add_node(<span class="string">&quot;node_c&quot;</span>, node_c)</span><br><span class="line"></span><br><span class="line">builder.set_entry_point(<span class="string">&quot;node_a&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建节点之间的边</span></span><br><span class="line">builder.add_conditional_edges(<span class="string">&quot;node_a&quot;</span>, routing_function, &#123;<span class="literal">True</span>: <span class="string">&quot;node_b&quot;</span>, <span class="literal">False</span>: <span class="string">&quot;node_c&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">builder.add_edge(<span class="string">&quot;node_b&quot;</span>, END)</span><br><span class="line">builder.add_edge(<span class="string">&quot;node_c&quot;</span>, END)</span><br><span class="line"></span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"></span><br><span class="line">display(Image(graph.get_graph(xray=<span class="literal">True</span>).draw_mermaid_png()))</span><br></pre></td></tr></table></figure>

<h3 id="6-1-2-结构化输出"><a href="#6-1-2-结构化输出" class="headerlink" title="6.1.2 结构化输出"></a>6.1.2 结构化输出</h3><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/3.png" alt="3"></p>
<p>在 <code>LangGraph</code> 中，<code>.with_structured_output()</code> 方法能生成符合指定模式的输出对象，比常规字符串输出更规范。支持以下三种方式定义输出结构：  </p>
<ol>
<li><strong>使用 Pydantic 模型</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInfo</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户信息，包括姓名、年龄、邮箱和电话（可选）&quot;&quot;&quot;</span></span><br><span class="line">    name: <span class="built_in">str</span> = Field(description=<span class="string">&quot;用户姓名&quot;</span>)</span><br><span class="line">    age: <span class="type">Optional</span>[<span class="built_in">int</span>] = Field(description=<span class="string">&quot;用户年龄&quot;</span>)</span><br><span class="line">    email: <span class="built_in">str</span> = Field(description=<span class="string">&quot;用户邮箱&quot;</span>)</span><br><span class="line">    phone: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(description=<span class="string">&quot;用户电话&quot;</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>使用 TypedDict</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated, TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInfo</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从文本提取的用户信息&quot;&quot;&quot;</span></span><br><span class="line">    name: Annotated[<span class="built_in">str</span>, ..., <span class="string">&quot;用户姓名&quot;</span>]</span><br><span class="line">    age: Annotated[<span class="type">Optional</span>[<span class="built_in">int</span>], <span class="literal">None</span>, <span class="string">&quot;用户年龄&quot;</span>]</span><br><span class="line">    email: Annotated[<span class="built_in">str</span>, ..., <span class="string">&quot;用户邮箱&quot;</span>]</span><br><span class="line">    phone: Annotated[<span class="type">Optional</span>[<span class="built_in">str</span>], <span class="literal">None</span>, <span class="string">&quot;用户电话&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>使用 JSON Schema</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">json_schema = &#123;</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;user_info&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;用户信息&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;用户姓名&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;age&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;用户年龄&quot;</span>, <span class="string">&quot;default&quot;</span>: <span class="literal">None</span>&#125;,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;用户邮箱&quot;</span>&#125;,</span><br><span class="line">        <span class="string">&quot;phone&quot;</span>: &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;用户电话&quot;</span>, <span class="string">&quot;default&quot;</span>: <span class="literal">None</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>应用示例</strong>  </p>
<p>将模型绑定到结构化输出模式，并提取信息：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">structured_llm = llm.with_structured_output(UserInfo)</span><br><span class="line">extracted_user_info = structured_llm.invoke(<span class="string">&quot;我叫奥特曼，今年38岁，邮箱地址是aoteman#qq.com，电话是1211111111&quot;</span>)</span><br><span class="line"><span class="comment"># isinstance 函数用于判断一个对象是否是一个已知的类型，或者是该类型的子类的实例</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(extracted_user_info, UserInfo):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;执行节点A的逻辑&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;执行节点B的逻辑&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="6-1-3-构建路由图"><a href="#6-1-3-构建路由图" class="headerlink" title="6.1.3 构建路由图"></a>6.1.3 构建路由图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入必要模块</span></span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span>, <span class="type">Optional</span>, Annotated, TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> AnyMessage, HumanMessage</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, sessionmaker</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化大语言模型对象</span></span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    model=<span class="string">&quot;gpt-4o&quot;</span>,</span><br><span class="line">    api_key=<span class="string">&quot;your_key&quot;</span>,</span><br><span class="line">    base_url=<span class="string">&quot;your_url&quot;</span>,</span><br><span class="line">    temperature=<span class="number">0</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用于接收用户信息的结构化模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInfo</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(description=<span class="string">&quot;用户姓名&quot;</span>)</span><br><span class="line">    age: <span class="type">Optional</span>[<span class="built_in">int</span>] = Field(description=<span class="string">&quot;用户年龄&quot;</span>)</span><br><span class="line">    email: <span class="built_in">str</span> = Field(description=<span class="string">&quot;用户邮箱地址&quot;</span>)</span><br><span class="line">    phone: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(description=<span class="string">&quot;用户电话号码&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用于自然语言回复的结构化模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConversationalResponse</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    response: <span class="built_in">str</span> = Field(description=<span class="string">&quot;模型给出的自然语言回答&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 封装最终输出模型，可能是用户信息也可能是自然语言回复</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FinalResponse</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    final_output: <span class="type">Union</span>[UserInfo, ConversationalResponse]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SQLAlchemy 数据库模型和连接配置（使用 SQLite）</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">50</span>))</span><br><span class="line">    age = Column(Integer)</span><br><span class="line">    email = Column(String(<span class="number">100</span>))</span><br><span class="line">    phone = Column(String(<span class="number">15</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># SQLite 数据库连接（在本地创建 langgraph.db 文件）</span></span><br><span class="line">DATABASE_URI = <span class="string">&#x27;sqlite:///langgraph.db&#x27;</span></span><br><span class="line">engine = create_engine(DATABASE_URI, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据表（如果不存在）</span></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库会话工厂</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义图状态结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>[AnyMessage], operator.add]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型对话节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chat_with_model</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;调用结构化模型获取回答&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(state)</span><br><span class="line">    <span class="comment"># print 预测示例: &#123;&#x27;messages&#x27;: [HumanMessage(content=&#x27;我叫张三，今年28岁，邮箱是zhangsan@example.com&#x27;)]&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----------------&quot;</span>)</span><br><span class="line">    structured_llm = llm.with_structured_output(FinalResponse)</span><br><span class="line">    response = structured_llm.invoke(state[<span class="string">&#x27;messages&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取自然语言回答节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">final_answer</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;返回自然语言格式的最终结果&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(state)</span><br><span class="line">    <span class="comment"># print 预测示例: &#123;&#x27;messages&#x27;: [FinalResponse(final_output=ConversationalResponse(response=&quot;你好，我是AI助手...&quot;))]&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----------------&quot;</span>)</span><br><span class="line">    response = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>].final_output.response</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入用户信息到数据库</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">insert_db</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;将提取出的用户信息保存到数据库中&quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>]</span><br><span class="line">        output = result.final_output</span><br><span class="line">        user = User(name=output.name, age=output.age, email=output.email, phone=output.phone)</span><br><span class="line">        session.add(user)</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;数据已成功存储至SQLite数据库。&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;数据存储失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断是否为用户信息，用于决定流程分支</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_branch</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    result = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>]</span><br><span class="line">    output = result.final_output</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">isinstance</span>(output, UserInfo)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 LangGraph 流程图</span></span><br><span class="line">graph = StateGraph(AgentState)</span><br><span class="line">graph.add_node(<span class="string">&quot;chat_with_model&quot;</span>, chat_with_model)</span><br><span class="line">graph.add_node(<span class="string">&quot;final_answer&quot;</span>, final_answer)</span><br><span class="line">graph.add_node(<span class="string">&quot;insert_db&quot;</span>, insert_db)</span><br><span class="line"></span><br><span class="line">graph.set_entry_point(<span class="string">&quot;chat_with_model&quot;</span>)</span><br><span class="line">graph.add_conditional_edges(<span class="string">&quot;chat_with_model&quot;</span>, generate_branch, &#123;</span><br><span class="line">    <span class="literal">True</span>: <span class="string">&quot;insert_db&quot;</span>,</span><br><span class="line">    <span class="literal">False</span>: <span class="string">&quot;final_answer&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line">graph.set_finish_point(<span class="string">&quot;final_answer&quot;</span>)</span><br><span class="line">graph.set_finish_point(<span class="string">&quot;insert_db&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译图</span></span><br><span class="line">graph = graph.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示流程图</span></span><br><span class="line">display(Image(graph.get_graph(xray=<span class="literal">True</span>).draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例输入测试（结构化提取）</span></span><br><span class="line">query = <span class="string">&quot;我叫奥特曼，今年38岁，邮箱地址是aoteman#qq.com，电话是1211111111&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># print 预测示例: UserInfo(name=&#x27;奥特曼&#x27;, age=38, email=&#x27;aoteman#qq.com&#x27;, phone=&#x27;1211111111&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例输入测试（自然语言问答）</span></span><br><span class="line">query = <span class="string">&quot;你好，请你介绍一下你自己&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># print 预测示例: &quot;你好，我是你的AI助手...&quot;</span></span><br><span class="line"></span><br><span class="line">query = <span class="string">&quot;请问什么是机器学习&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># print 预测示例: &quot;机器学习是一种人工智能方法...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次测试结构化提取</span></span><br><span class="line">query = <span class="string">&quot;我叫孙悟空，今年500岁，邮箱地址是wukong@gmial.com&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># print 预测示例: UserInfo(name=&#x27;孙悟空&#x27;, age=500, email=&#x27;wukong@gmial.com&#x27;, phone=None)</span></span><br></pre></td></tr></table></figure>

<h2 id="6-2-工具调用代理"><a href="#6-2-工具调用代理" class="headerlink" title="6.2 工具调用代理"></a>6.2 工具调用代理</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/5-1744608295214-1.png" alt="5"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 标准库</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span>, <span class="type">Optional</span>, Annotated, TypedDict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三方库</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, sessionmaker</span><br><span class="line"></span><br><span class="line"><span class="comment"># LangChain 和 LangGraph</span></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> AnyMessage, HumanMessage</span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"><span class="keyword">from</span> langgraph.prebuilt <span class="keyword">import</span> ToolNode</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义搜索查询的结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SearchQuery</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    query: <span class="built_in">str</span> = Field(description=<span class="string">&quot;Questions for networking queries&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索工具：从 Serper API 获取实时搜索结果</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema = SearchQuery</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_real_time_info</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Get real-time Internet information&quot;&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&quot;https://google.serper.dev/search&quot;</span></span><br><span class="line">    payload = json.dumps(&#123;<span class="string">&quot;q&quot;</span>: query, <span class="string">&quot;num&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;X-API-KEY&#x27;</span>: <span class="string">&#x27;42e8f4376266ffe61a1bdcef2297acb6c4a1b36b&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(url, headers=headers, data=payload)</span><br><span class="line">    data = json.loads(response.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;organic&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(data[<span class="string">&#x27;organic&#x27;</span>], ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;No organic results found&quot;</span>&#125;, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义天气查询结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherLoc</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    location: <span class="built_in">str</span> = Field(description=<span class="string">&quot;The location name of the city&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 天气工具：根据地点返回模拟天气信息</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema = WeatherLoc</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather</span>(<span class="params">location</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Call to get the current weather.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;北京的温度是16度，天气晴朗。&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用户信息结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserInfo</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(description=<span class="string">&quot;The name of the user&quot;</span>)</span><br><span class="line">    age: <span class="type">Optional</span>[<span class="built_in">int</span>] = Field(description=<span class="string">&quot;The age of the user&quot;</span>)</span><br><span class="line">    email: <span class="built_in">str</span> = Field(description=<span class="string">&quot;The email address of the user&quot;</span>)</span><br><span class="line">    phone: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(description=<span class="string">&quot;The phone number of the user&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户信息写入数据库工具</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema = UserInfo</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">insert_db</span>(<span class="params">name, age, email, phone</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Insert user information into the database, The required parameters are name, age, email, phone&quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User(name=name, age=age, email=email, phone=phone)</span><br><span class="line">        session.add(user)</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;数据已成功存储至Mysql数据库。&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;数据存储失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工具列表与工具节点</span></span><br><span class="line">tools = [insert_db, fetch_real_time_info, get_weather]</span><br><span class="line">tool_node = ToolNode(tools)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化大语言模型</span></span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    model=<span class="string">&quot;gpt-4o&quot;</span>,</span><br><span class="line">    api_key=<span class="string">&quot;your_key&quot;</span>,</span><br><span class="line">    base_url=<span class="string">&quot;your_url&quot;</span>,</span><br><span class="line">    temperature=<span class="number">0</span></span><br><span class="line">)</span><br><span class="line">model_with_tools = llm.bind_tools(tools)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义自然语言响应结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConversationalResponse</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    response: <span class="built_in">str</span> = Field(description=<span class="string">&quot;A conversational response to the user&#x27;s query&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义最终输出结构（可能是自然语言也可能是结构化数据）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FinalResponse</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    final_output: <span class="type">Union</span>[ConversationalResponse, SearchQuery, WeatherLoc, UserInfo]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库模型（SQLite）</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">50</span>))</span><br><span class="line">    age = Column(Integer)</span><br><span class="line">    email = Column(String(<span class="number">100</span>))</span><br><span class="line">    phone = Column(String(<span class="number">15</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库连接配置与初始化</span></span><br><span class="line">DATABASE_URI = <span class="string">&#x27;sqlite:///langgraph.db&#x27;</span></span><br><span class="line">engine = create_engine(DATABASE_URI, echo=<span class="literal">True</span>)</span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型处理节点：结构化输出</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chat_with_model</span>(<span class="params">state</span>):</span><br><span class="line">    messages = state[<span class="string">&#x27;messages&#x27;</span>]</span><br><span class="line">    structured_llm = llm.with_structured_output(FinalResponse)</span><br><span class="line">    response = structured_llm.invoke(messages)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自然语言响应节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">final_answer</span>(<span class="params">state</span>):</span><br><span class="line">    messages = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>]</span><br><span class="line">    response = messages.final_output.response</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工具执行节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_function</span>(<span class="params">state</span>):</span><br><span class="line">    messages = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>].final_output</span><br><span class="line">    response = tool_node.invoke(&#123;<span class="string">&quot;messages&quot;</span>: [model_with_tools.invoke(<span class="built_in">str</span>(messages))]&#125;)</span><br><span class="line">    response = response[<span class="string">&quot;messages&quot;</span>][<span class="number">0</span>].content</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态结构定义</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>[AnyMessage], operator.add]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断是否为结构化调用（用于路由分支）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_branch</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    result = state[<span class="string">&#x27;messages&#x27;</span>][-<span class="number">1</span>]</span><br><span class="line">    output = result.final_output</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(output, ConversationalResponse)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 LangGraph 流程图</span></span><br><span class="line">graph = StateGraph(AgentState)</span><br><span class="line">graph.add_node(<span class="string">&quot;chat_with_model&quot;</span>, chat_with_model)</span><br><span class="line">graph.add_node(<span class="string">&quot;final_answer&quot;</span>, final_answer)</span><br><span class="line">graph.add_node(<span class="string">&quot;execute_function&quot;</span>, execute_function)</span><br><span class="line">graph.set_entry_point(<span class="string">&quot;chat_with_model&quot;</span>)</span><br><span class="line">graph.add_conditional_edges(<span class="string">&quot;chat_with_model&quot;</span>, generate_branch, &#123;</span><br><span class="line">    <span class="literal">True</span>: <span class="string">&quot;execute_function&quot;</span>,</span><br><span class="line">    <span class="literal">False</span>: <span class="string">&quot;final_answer&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line">graph.set_finish_point(<span class="string">&quot;final_answer&quot;</span>)</span><br><span class="line">graph.set_finish_point(<span class="string">&quot;execute_function&quot;</span>)</span><br><span class="line">graph = graph.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示流程图</span></span><br><span class="line">display(Image(graph.get_graph(xray=<span class="literal">True</span>).draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例测试：普通对话</span></span><br><span class="line">query = <span class="string">&quot;你好，请你介绍一下你自己&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例测试：搜索引擎调用</span></span><br><span class="line">query = <span class="string">&quot;查询小米汽车&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例测试：天气查询</span></span><br><span class="line">query = <span class="string">&quot;北京的天气怎么样？&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例测试：用户信息提取并存储</span></span><br><span class="line">query = <span class="string">&quot;我叫奥特曼a，今年38岁，邮箱地址是aoteman@qq.com，电话是1211111111&quot;</span></span><br><span class="line">input_message = &#123;<span class="string">&quot;messages&quot;</span>: [HumanMessage(content=query)]&#125;</span><br><span class="line">result = graph.invoke(input_message)</span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li><strong>状态必须包含消息列表。</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>[AnyMessage], operator.add]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>最后一条消息必须是AIMessage。</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response = structured_llm.invoke(messages)</span><br><span class="line"><span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>AIMessage必须填充tool_calls。</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response = tool_node.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;messages&quot;</span>: [model_with_tools.invoke(<span class="built_in">str</span>(messages))]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="6-3-ReAct"><a href="#6-3-ReAct" class="headerlink" title="6.3 ReAct"></a>6.3 ReAct</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2-1744613634483-3.png" alt="2"></p>
<p>&emsp;&emsp;<code>LangGraph</code>预构建的<code>ReAct</code>组件，其实就是通过接入大模型，搭配着<code>Tool Calling Agent</code>，再结合<code>Router Agent</code> 共同构建起来的图，这个图以自治循环代理的架构形式提供服务。</p>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/6.png" alt="6"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String, Float</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, declarative_base</span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langgraph.prebuilt <span class="keyword">import</span> create_react_agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 SQLAlchemy ORM 基类</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义天气数据表结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Weather</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;weather&#x27;</span></span><br><span class="line">    city_id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    city_name = Column(String(<span class="number">50</span>))</span><br><span class="line">    main_weather = Column(String(<span class="number">50</span>))</span><br><span class="line">    description = Column(String(<span class="number">100</span>))</span><br><span class="line">    temperature = Column(Float)</span><br><span class="line">    feels_like = Column(Float)</span><br><span class="line">    temp_min = Column(Float)</span><br><span class="line">    temp_max = Column(Float)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置数据库连接为本地 SQLite 文件</span></span><br><span class="line">DATABASE_URI = <span class="string">&#x27;sqlite:///langgraph_weather.db&#x27;</span></span><br><span class="line">engine = create_engine(DATABASE_URI)</span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义查询天气所需参数结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherLoc</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    location: <span class="built_in">str</span> = Field(description=<span class="string">&quot;城市名称&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义天气信息结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WeatherInfo</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    city_id: <span class="built_in">int</span> = Field(..., description=<span class="string">&quot;城市唯一标识&quot;</span>)</span><br><span class="line">    city_name: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;城市名称&quot;</span>)</span><br><span class="line">    main_weather: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;主要天气状况&quot;</span>)</span><br><span class="line">    description: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;天气描述&quot;</span>)</span><br><span class="line">    temperature: <span class="built_in">float</span> = Field(..., description=<span class="string">&quot;当前气温&quot;</span>)</span><br><span class="line">    feels_like: <span class="built_in">float</span> = Field(..., description=<span class="string">&quot;体感温度&quot;</span>)</span><br><span class="line">    temp_min: <span class="built_in">float</span> = Field(..., description=<span class="string">&quot;最低气温&quot;</span>)</span><br><span class="line">    temp_max: <span class="built_in">float</span> = Field(..., description=<span class="string">&quot;最高气温&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工具1：调用 OpenWeather API 获取实时天气</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=WeatherLoc</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather</span>(<span class="params">location</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取指定城市的模拟天气信息（不调用外部API，所有城市返回相同的数据）。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 模拟固定天气数据</span></span><br><span class="line">    simulated_data = &#123;</span><br><span class="line">        <span class="string">&quot;city_id&quot;</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="string">&quot;city_name&quot;</span>: location,</span><br><span class="line">        <span class="string">&quot;main_weather&quot;</span>: <span class="string">&quot;Clear&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;晴朗&quot;</span>,</span><br><span class="line">        <span class="string">&quot;temperature&quot;</span>: <span class="number">26.0</span>,</span><br><span class="line">        <span class="string">&quot;feels_like&quot;</span>: <span class="number">27.2</span>,</span><br><span class="line">        <span class="string">&quot;temp_min&quot;</span>: <span class="number">21.0</span>,</span><br><span class="line">        <span class="string">&quot;temp_max&quot;</span>: <span class="number">30.0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> simulated_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工具2：将天气信息存入数据库</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=WeatherInfo</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">insert_weather_to_db</span>(<span class="params">city_id, city_name, main_weather, description, temperature, feels_like, temp_min, temp_max</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将获取到的天气信息存储至数据库中</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        weather = Weather(</span><br><span class="line">            city_id=city_id,</span><br><span class="line">            city_name=city_name,</span><br><span class="line">            main_weather=main_weather,</span><br><span class="line">            description=description,</span><br><span class="line">            temperature=temperature,</span><br><span class="line">            feels_like=feels_like,</span><br><span class="line">            temp_min=temp_min,</span><br><span class="line">            temp_max=temp_max</span><br><span class="line">        )</span><br><span class="line">        session.merge(weather)</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;天气数据已成功存储至数据库&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        session.rollback()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;数据存储失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工具3：通过城市名查询数据库中的天气信息</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QueryWeatherSchema</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    city_name: <span class="built_in">str</span> = Field(..., description=<span class="string">&quot;待查询的城市名&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=QueryWeatherSchema</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_weather_from_db</span>(<span class="params">city_name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从数据库中查询指定城市的天气信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        weather_data = session.query(Weather).<span class="built_in">filter</span>(Weather.city_name == city_name).first()</span><br><span class="line">        <span class="keyword">if</span> weather_data:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;city_id&quot;</span>: weather_data.city_id,</span><br><span class="line">                <span class="string">&quot;city_name&quot;</span>: weather_data.city_name,</span><br><span class="line">                <span class="string">&quot;main_weather&quot;</span>: weather_data.main_weather,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: weather_data.description,</span><br><span class="line">                <span class="string">&quot;temperature&quot;</span>: weather_data.temperature,</span><br><span class="line">                <span class="string">&quot;feels_like&quot;</span>: weather_data.feels_like,</span><br><span class="line">                <span class="string">&quot;temp_min&quot;</span>: weather_data.temp_min,</span><br><span class="line">                <span class="string">&quot;temp_max&quot;</span>: weather_data.temp_max</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;未找到城市 &#x27;<span class="subst">&#123;city_name&#125;</span>&#x27; 的天气信息&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;查询失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工具4：调用 Serper API 获取互联网实时信息</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SearchQuery</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    query: <span class="built_in">str</span> = Field(description=<span class="string">&quot;要检索的实时问题&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=SearchQuery</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_real_time_info</span>(<span class="params">query</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    使用 Serper API 获取实时搜索结果</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&quot;https://google.serper.dev/search&quot;</span></span><br><span class="line">    payload = json.dumps(&#123;<span class="string">&quot;q&quot;</span>: query, <span class="string">&quot;num&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;X-API-KEY&#x27;</span>: <span class="string">&#x27;42e8f4376266ffe61a1bdcef2297acb6c4a1b36b&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(url, headers=headers, data=payload)</span><br><span class="line">    data = json.loads(response.text)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(data.get(<span class="string">&#x27;organic&#x27;</span>, &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;未找到相关结果&quot;</span>&#125;), ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册所有工具</span></span><br><span class="line">tools = [fetch_real_time_info, get_weather, insert_weather_to_db, query_weather_from_db]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 LLM 和智能体图谱</span></span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,</span><br><span class="line">    api_key=<span class="string">&quot;your_key&quot;</span>,</span><br><span class="line">    base_url=<span class="string">&quot;your_url&quot;</span>,</span><br><span class="line">    temperature=<span class="number">0</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">graph = create_react_agent(llm, tools=tools)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例调用</span></span><br><span class="line">finan_response = graph.invoke(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你好，请你介绍一下你自己&quot;</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span>(finan_response[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br><span class="line">finan_response = graph.invoke(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;北京今天的天气怎么样？&quot;</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span>(finan_response[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br><span class="line">finan_response = graph.invoke(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你知道关于小米的销售情况吗？请用中文回复我&quot;</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span>(finan_response[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br><span class="line">finan_response = graph.invoke(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;帮我查一下北京、上海，哈尔滨三个城市的天气，告诉我哪个城市最适合出游。同时，把查询到的数据存储到数据库中&quot;</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span>(finan_response[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br><span class="line">finan_response = graph.invoke(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;帮我分析一下数据库中北京和哈尔滨城市天气的信息，做一个详细的对比，并生成出行建议&quot;</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span>(finan_response[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>create_react_agent</code>这个<code>LangGraph</code>框架中预构建的方法来创建自治循环代理（ReAct）的工作流：</p>
<ol>
<li><p><strong>定义图状态模式</strong></p>
<ul>
<li><code>LangGraph</code>中的主要图类型是<code>StateGraph</code>。每个节点通过<code>State</code>中的参数获取有效信息，执行完节点的内部逻辑后，更新该<code>State</code>状态中的值。不同的状态模式，可以通过注释设置状态的特定属性（例如覆盖现有值）或添加到现有属性。</li>
</ul>
</li>
<li><p><strong>定义<code>Router Function</code></strong></p>
<ul>
<li>设置边缘条件，有条件的原因是，根据节点的输出，可以采用多个路径之一。在该节点运行之前，所采用的路径是未知的（由大模型决定）。<ul>
<li>条件边缘：调用代理后，如果代理说要采取行动，那么应该调用调用工具的函数。如果代理说已经完成，那么就应该完成。</li>
<li>正常边：调用工具后，它应该始终返回给代理来决定下一步做什么。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>定义大模型的交互函数</strong></p>
<ul>
<li>接下来需要通过一个节点函数加载我想要使用的大模型。它需要满足两个标准：<ul>
<li>应该与消息一起使用，因为图的状态主要是消息列表（聊天历史记录）。</li>
<li>需要与工具调用一起使用，其内部使用的是预构建的ToolNode。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>构建图结构</strong></p>
<ul>
<li>最后，把上述所有的组件放在一起构建图结构，这与我们手动构建图的方式基本一致。</li>
</ul>
</li>
</ol>
</blockquote>
<h1 id="7-事件流"><a href="#7-事件流" class="headerlink" title="7. 事件流"></a>7. 事件流</h1><h2 id="7-1-LangChain事件流"><a href="#7-1-LangChain事件流" class="headerlink" title="7.1 LangChain事件流"></a>7.1 LangChain事件流</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunks = []</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> llm.astream(<span class="string">&quot;你好，请你详细的介绍一下你自己。&quot;</span>):</span><br><span class="line">    chunks.append(chunk)</span><br><span class="line">    <span class="built_in">print</span>(chunk.content, end=<span class="string">&quot;|&quot;</span>, flush=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="7-2-LangGraph事件流"><a href="#7-2-LangGraph事件流" class="headerlink" title="7.2 LangGraph事件流"></a>7.2 LangGraph事件流</h2><p>其实现方式也是和<code>LangChain</code>一样通过<code>.stream</code>和<code>.astream</code>方法执行流式输出，只不过适配到了图结构中。调用<code>.stream</code>和<code>.astream</code>方法时可以指定几种不同的模式，即：</p>
<ul>
<li>“values” ：在图中的每个步骤之后流式传输<strong>状态</strong>的完整值。</li>
<li>“updates” ：在图中的每个步骤之后将更新流式传输到状态。如果在同一步骤中进行多个更新（例如运行多个节点），则这些更新将单独流式传输。</li>
<li>“debug” ：在整个图的执行过程中流式传输尽可能多的信息，主要用于调试程序。</li>
<li>“messages”：记录每个<code>messages</code>中的增量<code>token</code>。</li>
<li>“custom”：自定义流，通过<code>LangGraph 的 StreamWriter</code>方法</li>
</ul>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1744619866364-6.png" alt="1"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="comment"># 异步主函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> event <span class="keyword">in</span> graph.astream_events(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你好，请你介绍一下你自己&quot;</span>]&#125;, version=<span class="string">&quot;v2&quot;</span>):</span><br><span class="line">        kind = event[<span class="string">&quot;event&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> kind == <span class="string">&quot;on_chat_model_stream&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(event[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;chunk&quot;</span>].content, end=<span class="string">&quot;|&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动异步事件循环</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<blockquote>
<p>&emsp;&emsp;所有事件都会包含<code>event</code> 、 <code>name</code>和<code>data</code>字段，其中：</p>
<ul>
<li>event ：正在发出的事件类型。</li>
<li>name ：这是事件的名称</li>
<li>data ：这是与事件关联的数据。</li>
</ul>
</blockquote>
<h1 id="8-长短期记忆"><a href="#8-长短期记忆" class="headerlink" title="8. 长短期记忆"></a>8. 长短期记忆</h1><h2 id="8-1-状态（State）"><a href="#8-1-状态（State）" class="headerlink" title="8.1 状态（State）"></a>8.1 状态（State）</h2><ol>
<li><code>State</code> 是用于在 <strong>单次运行期间</strong> 维持图中所有节点共享的消息状态。</li>
<li>每次运行图之后，状态会自动<strong>重置</strong>，不会保留上次运行的历史消息。</li>
<li>即使是连续向同一个图发送多个消息，每一轮运行都被视为完全独立的上下文。</li>
<li>优点在于确保运行独立性，防止运行之间状态相互干扰。</li>
<li>常见误区是误以为 <code>State</code> 会自动保存消息历史，其实它不具备跨运行的记忆能力。</li>
</ol>
<h2 id="8-2-记忆机制"><a href="#8-2-记忆机制" class="headerlink" title="8.2 记忆机制"></a>8.2 记忆机制</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/a.png" alt="a"></p>
<ul>
<li><strong>短期记忆：允许代理访问图中较早步骤中获取的信息，并且可以可以随时从与用户的单个对话线程中调用。</strong></li>
<li><strong>长期记忆：使代理能够回忆起之前交互中的信息，例如对话中过去的消息，并且可以在对话线程之间共享，在任何时间、任何线程中调用。</strong></li>
</ul>
<h3 id="8-2-1-短期记忆与-Checkpointer（检查点）"><a href="#8-2-1-短期记忆与-Checkpointer（检查点）" class="headerlink" title="8.2.1 短期记忆与 Checkpointer（检查点）"></a>8.2.1 短期记忆与 Checkpointer（检查点）</h3><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/b.png" alt="b"></p>
<p>LangGraph 中每个阶段会生成一个任务 (<code>task</code>)，包含两个阶段：</p>
<ul>
<li><strong>生成阶段</strong>：当前事件。</li>
<li><strong>执行结果阶段</strong>：<code>task_result</code>。</li>
</ul>
<p>每个任务及消息（包括用户和模型）都有唯一 ID。</p>
<p>为了实现上下文短期记忆，LangGraph 提供了 <code>checkpointer</code> 模块，用于在任务开始时恢复之前的状态数据，支持以下实现方式：</p>
<h4 id="8-2-1-1-MemorySaver（内存存储，适合实验）"><a href="#8-2-1-1-MemorySaver（内存存储，适合实验）" class="headerlink" title="8.2.1.1 MemorySaver（内存存储，适合实验）"></a>8.2.1.1 MemorySaver（内存存储，适合实验）</h4><ul>
<li>将中间状态存储在内存中，适合轻量和临时测试。</li>
<li>需结合 <code>thread_id</code> 使用，确保状态在线程间可关联。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">memory = MemorySaver()</span><br><span class="line">graph_with_memory = builder.<span class="built_in">compile</span>(checkpointer=memory)</span><br><span class="line"></span><br><span class="line">config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;1&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> graph_with_memory.stream(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你好，我叫西瓜老师&quot;</span>]&#125;, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">    chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> graph_with_memory.stream(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;请问我叫什么？&quot;</span>]&#125;, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">    chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>每次使用相同 <code>thread_id</code>，将自动恢复上次保存的状态，实现短期记忆。</p>
</blockquote>
<h4 id="8-2-1-2-SqliteSaver-AsyncSqliteSaver（本地-SQLite-存储）"><a href="#8-2-1-2-SqliteSaver-AsyncSqliteSaver（本地-SQLite-存储）" class="headerlink" title="8.2.1.2 SqliteSaver &#x2F; AsyncSqliteSaver（本地 SQLite 存储）"></a>8.2.1.2 SqliteSaver &#x2F; AsyncSqliteSaver（本地 SQLite 存储）</h4><ul>
<li>支持将状态持久化存储在 SQLite 数据库中。</li>
<li>异步版本适用于异步环境。</li>
<li>更适合本地落地、轻量生产环境。</li>
</ul>
<p><strong>内存模式：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.checkpoint.sqlite <span class="keyword">import</span> SqliteSaver</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> SqliteSaver.from_conn_string(<span class="string">&quot;:memory:&quot;</span>) <span class="keyword">as</span> checkpointer:</span><br><span class="line">    graph = create_react_agent(llm, tools=tools, checkpointer=checkpointer)</span><br><span class="line"></span><br><span class="line">    config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;11&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你好，我叫西瓜老师&quot;</span>]&#125;, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure>

<p><strong>持久化模式：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> SqliteSaver.from_conn_string(<span class="string">&quot;checkpoints20251101.sqlite&quot;</span>) <span class="keyword">as</span> checkpointer:</span><br><span class="line">    graph = create_react_agent(llm, tools=tools, checkpointer=checkpointer)</span><br><span class="line"></span><br><span class="line">    config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;11&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你好，我叫西瓜老师&quot;</span>]&#125;, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br></pre></td></tr></table></figure>

<h4 id="8-1-2-3-PostgresSaver-AsyncPostgresSaver（生产级持久化）"><a href="#8-1-2-3-PostgresSaver-AsyncPostgresSaver（生产级持久化）" class="headerlink" title="8.1.2.3 PostgresSaver &#x2F; AsyncPostgresSaver（生产级持久化）"></a>8.1.2.3 PostgresSaver &#x2F; AsyncPostgresSaver（生产级持久化）</h4><ul>
<li>使用 PostgreSQL 数据库存储检查点，适用于生产环境。</li>
<li>支持异步操作。</li>
</ul>
<h4 id="8-1-2-4-自定义检查点（Advanced）"><a href="#8-1-2-4-自定义检查点（Advanced）" class="headerlink" title="8.1.2.4 自定义检查点（Advanced）"></a>8.1.2.4 <strong>自定义检查点（Advanced）</strong></h4><ul>
<li>用户可自定义检查点逻辑，用于接入其他存储后端（如 Redis、MongoDB、云存储等）。</li>
</ul>
<h3 id="8-2-2-长期记忆和Store（仓库）"><a href="#8-2-2-长期记忆和Store（仓库）" class="headerlink" title="8.2.2 长期记忆和Store（仓库）"></a>8.2.2 长期记忆和Store（仓库）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 标准库导入</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableConfig</span><br><span class="line"><span class="comment"># LangChain 相关导入</span></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langgraph.checkpoint.memory <span class="keyword">import</span> MemorySaver</span><br><span class="line"><span class="comment"># LangGraph 相关导入</span></span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, START, END, MessagesState</span><br><span class="line"><span class="keyword">from</span> langgraph.graph.message <span class="keyword">import</span> add_messages</span><br><span class="line"><span class="keyword">from</span> langgraph.store.base <span class="keyword">import</span> BaseStore</span><br><span class="line"><span class="keyword">from</span> langgraph.store.memory <span class="keyword">import</span> InMemoryStore</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化内存存储和检查点机制</span></span><br><span class="line">in_memory_store = InMemoryStore()  <span class="comment"># 用于存储对话记忆</span></span><br><span class="line">memory = MemorySaver()  <span class="comment"># 用于保存检查点状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化大语言模型</span></span><br><span class="line">llm = ChatOpenAI(</span><br><span class="line">    model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,  <span class="comment"># 模型名称</span></span><br><span class="line">    api_key=<span class="string">&quot;your_key&quot;</span>,  <span class="comment"># API密钥</span></span><br><span class="line">    base_url=<span class="string">&quot;your_url&quot;</span>,  <span class="comment"># API基础URL</span></span><br><span class="line">    temperature=<span class="number">0</span>,  <span class="comment"># 温度参数，控制生成结果的随机性</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义状态结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;对话状态定义，包含消息序列&quot;&quot;&quot;</span></span><br><span class="line">    messages: Annotated[<span class="built_in">list</span>, add_messages]  <span class="comment"># 可追加的消息列表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义对话处理节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_model</span>(<span class="params">state: MessagesState, config: RunnableConfig, *, store: BaseStore</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    对话处理核心函数：</span></span><br><span class="line"><span class="string">    1. 检索用户历史记忆</span></span><br><span class="line"><span class="string">    2. 处理当前消息</span></span><br><span class="line"><span class="string">    3. 调用大模型生成回复</span></span><br><span class="line"><span class="string">    4. 存储对话记忆</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        state: 当前对话状态</span></span><br><span class="line"><span class="string">        config: 运行配置</span></span><br><span class="line"><span class="string">        store: 记忆存储对象</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 从配置中获取用户ID</span></span><br><span class="line">    user_id = config[<span class="string">&quot;configurable&quot;</span>][<span class="string">&quot;user_id&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义记忆存储的命名空间</span></span><br><span class="line">    namespace = (<span class="string">&quot;memories&quot;</span>, user_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检索该用户的历史记忆</span></span><br><span class="line">    memories = store.search(namespace)</span><br><span class="line">    <span class="comment"># 将记忆内容拼接为上下文字符串</span></span><br><span class="line">    context = <span class="string">&quot;\n&quot;</span>.join([d.value[<span class="string">&quot;data&quot;</span>] <span class="keyword">for</span> d <span class="keyword">in</span> memories])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 存储用户最新输入</span></span><br><span class="line">    last_message = state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line">    store.put(namespace, <span class="built_in">str</span>(uuid.uuid4()), &#123;<span class="string">&quot;data&quot;</span>: last_message.content&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造系统提示，包含历史上下文</span></span><br><span class="line">    system_msg = <span class="string">f&quot;根据以下上下文回答用户问题:\n<span class="subst">&#123;context&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用大模型生成回复</span></span><br><span class="line">    response = llm.invoke(</span><br><span class="line">        [&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_msg&#125;] + state[<span class="string">&quot;messages&quot;</span>]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 存储模型生成的回复</span></span><br><span class="line">    store.put(namespace, <span class="built_in">str</span>(uuid.uuid4()), &#123;<span class="string">&quot;data&quot;</span>: response.content&#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: response&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 构建对话图 ==========</span></span><br><span class="line">builder = StateGraph(State)  <span class="comment"># 创建状态图构建器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加节点</span></span><br><span class="line">builder.add_node(<span class="string">&quot;call_model&quot;</span>, call_model)  <span class="comment"># 添加对话处理节点</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建边关系</span></span><br><span class="line">builder.add_edge(START, <span class="string">&quot;call_model&quot;</span>)  <span class="comment"># 开始节点到对话节点</span></span><br><span class="line">builder.add_edge(<span class="string">&quot;call_model&quot;</span>, END)  <span class="comment"># 对话节点到结束节点</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译图，绑定记忆存储和检查点机制</span></span><br><span class="line">graph = builder.<span class="built_in">compile</span>(checkpointer=memory, store=in_memory_store)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========== 主函数 ==========</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主测试函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 配置两个不同的对话线程</span></span><br><span class="line">    config_1 = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;111&quot;</span>&#125;, <span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;8&quot;</span>&#125;  <span class="comment"># 用户8的配置</span></span><br><span class="line">    config_2 = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;22&quot;</span>&#125;, <span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;9&quot;</span>&#125;  <span class="comment"># 用户9的配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试用户8的第一轮对话</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== 用户8第一轮对话 ===&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(</span><br><span class="line">            &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你好，我是西瓜老师&quot;</span>]&#125;,</span><br><span class="line">            config_1,</span><br><span class="line">            stream_mode=<span class="string">&quot;values&quot;</span></span><br><span class="line">    ):</span><br><span class="line">        chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试用户8的第二轮对话（验证记忆功能）</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 用户8第二轮对话 ===&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(</span><br><span class="line">            &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你知道我叫什么吗？&quot;</span>]&#125;,</span><br><span class="line">            config_1,</span><br><span class="line">            stream_mode=<span class="string">&quot;values&quot;</span></span><br><span class="line">    ):</span><br><span class="line">        chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试新用户9的对话（验证记忆隔离）</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 用户9对话 ===&quot;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(</span><br><span class="line">            &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;你知道我叫什么吗？&quot;</span>]&#125;,</span><br><span class="line">            config_2,</span><br><span class="line">            stream_mode=<span class="string">&quot;values&quot;</span></span><br><span class="line">    ):</span><br><span class="line">        chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 打印记忆存储内容</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 记忆存储内容 ===&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;用户8的记忆:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> memory <span class="keyword">in</span> in_memory_store.search((<span class="string">&quot;memories&quot;</span>, <span class="string">&quot;8&quot;</span>)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot; - <span class="subst">&#123;memory.value[<span class="string">&#x27;data&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n用户9的记忆:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> memory <span class="keyword">in</span> in_memory_store.search((<span class="string">&quot;memories&quot;</span>, <span class="string">&quot;9&quot;</span>)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot; - <span class="subst">&#123;memory.value[<span class="string">&#x27;data&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h1 id="9-Human-in-the-loop"><a href="#9-Human-in-the-loop" class="headerlink" title="9. Human-in-the-loop"></a>9. Human-in-the-loop</h1><h2 id="9-1-背景与需求"><a href="#9-1-背景与需求" class="headerlink" title="9.1 背景与需求"></a>9.1 背景与需求</h2><ul>
<li><strong>目标</strong>：在保持 AI Agent 自主决策能力的同时，对高风险操作（如删除生产数据库、转账等）引入人工审批，避免不可控风险。</li>
<li><strong>解决方案</strong>：结合 Human‑in‑the‑loop（HIL）思想，在关键节点暂停 Agent 执行，等待人工确认后再继续。</li>
</ul>
<h2 id="9-2-HIL-常见交互模式"><a href="#9-2-HIL-常见交互模式" class="headerlink" title="9.2 HIL 常见交互模式"></a>9.2 HIL 常见交互模式</h2><ul>
<li><strong>批准（Approval）</strong>：暂停流程，向用户展示当前状态，人工批准或拒绝。</li>
<li><strong>编辑（Editing）</strong>：暂停流程，允许用户修改 Agent 状态。</li>
<li><strong>输入（Input）</strong>：设计专门节点收集用户输入，并更新 Agent 状态。</li>
</ul>
<h2 id="9-3-在-LangGraph-中的实现思路"><a href="#9-3-在-LangGraph-中的实现思路" class="headerlink" title="9.3 在 LangGraph 中的实现思路"></a>9.3 在 LangGraph 中的实现思路</h2><ol>
<li><strong>图结构 &amp; 状态传递</strong>：底层用有向图表示任务流程，每个节点执行后更新全局状态。</li>
<li><strong>Checkpoint 持久化</strong>：通过 <code>checkpointer</code>（如 MemorySaver）在独立线程保存每个节点状态，可随时提取和修改。</li>
<li><strong>断点（Breakpoint）</strong>：在图编译时指定 <code>interrupt_before</code> 或 <code>interrupt_after</code>，在该节点执行前&#x2F;后暂停。</li>
<li><strong>恢复执行</strong>：人工确认后，调用 <code>.update_state</code> 更新状态，再次调用 <code>.astream</code> 或 <code>.stream</code> 继续执行。</li>
</ol>
<h2 id="9-4-代码示例"><a href="#9-4-代码示例" class="headerlink" title="9.4 代码示例"></a>9.4 代码示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> Image, display</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> SystemMessage, HumanMessage, AIMessage</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langgraph.checkpoint.memory <span class="keyword">import</span> MemorySaver</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, START, END</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 OpenAI 模型（自定义 API 接口）</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义状态数据结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    user_input: <span class="built_in">str</span></span><br><span class="line">    model_response: <span class="built_in">str</span></span><br><span class="line">    user_approval: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型节点：检查输入是否为高风险（如删除操作），若是则触发人工审批</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_model</span>(<span class="params">state: State</span>) -&gt; State:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;删除&#x27;</span> <span class="keyword">in</span> state[<span class="string">&#x27;user_input&#x27;</span>]:</span><br><span class="line">        state[<span class="string">&#x27;user_approval&#x27;</span>] = <span class="string">f&quot;用户输入的指令是:<span class="subst">&#123;state[<span class="string">&#x27;user_input&#x27;</span>]&#125;</span>, 请人工确认是否执行！&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        response = llm.invoke(state[<span class="string">&#x27;user_input&#x27;</span>])</span><br><span class="line">        state[<span class="string">&#x27;model_response&#x27;</span>] = response</span><br><span class="line">        state[<span class="string">&#x27;user_approval&#x27;</span>] = <span class="string">&#x27;直接运行！&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行审批结果：根据人工确认是否继续执行操作</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_users</span>(<span class="params">state: State</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&#x27;user_approval&#x27;</span>] == <span class="string">&#x27;是&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;model_response&#x27;</span>: AIMessage(<span class="string">&quot;删除已获批准并执行。&quot;</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&#x27;user_approval&#x27;</span>] == <span class="string">&#x27;否&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;model_response&#x27;</span>: AIMessage(<span class="string">&quot;操作被拒绝，未执行。&quot;</span>)&#125;</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 翻译节点：将模型响应翻译为英文</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">translate_message</span>(<span class="params">state: State</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    prompt = <span class="string">&quot;Please translate the received text into English.&quot;</span></span><br><span class="line">    msgs = [SystemMessage(prompt), HumanMessage(state[<span class="string">&#x27;model_response&#x27;</span>].content)]</span><br><span class="line">    response = llm.invoke(msgs)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;model_response&#x27;</span>: response&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建图：添加节点与边</span></span><br><span class="line">builder = StateGraph(State)</span><br><span class="line">builder.add_node(<span class="string">&#x27;call_model&#x27;</span>, call_model)</span><br><span class="line">builder.add_node(<span class="string">&#x27;execute_users&#x27;</span>, execute_users)</span><br><span class="line">builder.add_node(<span class="string">&#x27;translate_message&#x27;</span>, translate_message)</span><br><span class="line">builder.add_edge(START, <span class="string">&#x27;call_model&#x27;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&#x27;call_model&#x27;</span>, <span class="string">&#x27;execute_users&#x27;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&#x27;execute_users&#x27;</span>, <span class="string">&#x27;translate_message&#x27;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&#x27;translate_message&#x27;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用内存保存图状态，并在指定节点前中断（用于人工审批）</span></span><br><span class="line">memory = MemorySaver()</span><br><span class="line">graph = builder.<span class="built_in">compile</span>(</span><br><span class="line">    checkpointer=memory,</span><br><span class="line">    interrupt_before=[<span class="string">&#x27;execute_users&#x27;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可视化图结构</span></span><br><span class="line">display(Image(graph.get_graph().draw_mermaid_png()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化执行线程配置</span></span><br><span class="line">config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;2&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义异步主函数</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 第一次运行：触发删除操作，进入断点</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(&#123;<span class="string">&quot;user_input&quot;</span>: <span class="string">&quot;我将在数据库中删除 id 为 xigualaoshi 的所有信息&quot;</span>&#125;, config,</span><br><span class="line">                                     stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line"></span><br><span class="line">    snapshot = graph.get_state(config)</span><br><span class="line">    snapshot.values[<span class="string">&#x27;user_approval&#x27;</span>] = <span class="string">&#x27;是&#x27;</span></span><br><span class="line">    graph.update_state(config, snapshot.values)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(<span class="literal">None</span>, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(&#123;<span class="string">&quot;user_input&quot;</span>: <span class="string">&quot;我将在数据库中删除 id 为 xigualaoshi222 的所有信息&quot;</span>&#125;, config,</span><br><span class="line">                                     stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line"></span><br><span class="line">    snapshot = graph.get_state(config)</span><br><span class="line">    snapshot.values[<span class="string">&#x27;user_approval&#x27;</span>] = <span class="string">&#x27;否&#x27;</span></span><br><span class="line">    graph.update_state(config, snapshot.values)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(<span class="literal">None</span>, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(&#123;<span class="string">&quot;user_input&quot;</span>: <span class="string">&quot;你好，请你介绍一下你自己&quot;</span>&#125;, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(<span class="literal">None</span>, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用主函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li><strong>编译时设置断点</strong>：<code>interrupt_before</code> 或 <code>interrupt_after</code>。</li>
<li><strong>持久化状态</strong>：传入 <code>checkpointer</code>，如 <code>MemorySaver()</code>。</li>
<li><strong>运行至断点</strong>：<code>graph.astream(&#123;&#39;user_input&#39;: ...&#125;, config)</code>。</li>
<li><strong>人工审批</strong>：通过 <code>graph.get_state</code> + <code>.update_state</code> 填充 <code>user_approval</code>。</li>
<li><strong>恢复并完成</strong>：再次调用 <code>.astream</code> 或 <code>.stream</code>，获取最终响应。</li>
</ol>
</blockquote>
<h2 id="9-5-多轮对话封装示例"><a href="#9-5-多轮对话封装示例" class="headerlink" title="9.5 多轮对话封装示例"></a>9.5 多轮对话封装示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_dialogue</span>(<span class="params">graph, config, all_chunks=[]</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 接收用户输入</span></span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;请输入您的消息（输入&#x27;退出&#x27;结束对话）：&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> user_input.lower() == <span class="string">&#x27;退出&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 运行图，直至到断点的节点</span></span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;user_input&quot;</span>: user_input&#125;, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">            all_chunks.append(chunk)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理可能的审批请求</span></span><br><span class="line">        last_chunk = all_chunks[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> last_chunk[<span class="string">&quot;user_approval&quot;</span>] == <span class="string">f&quot;用户输入的指令是:<span class="subst">&#123;last_chunk[<span class="string">&#x27;user_input&#x27;</span>]&#125;</span>, 请人工确认是否执行！&quot;</span>:</span><br><span class="line">            user_approval = <span class="built_in">input</span>(<span class="string">f&quot;当前用户的输入是：<span class="subst">&#123;last_chunk[<span class="string">&#x27;user_input&#x27;</span>]&#125;</span>, 请人工确认是否执行！请回复 是/否。&quot;</span>)</span><br><span class="line">            graph.update_state(config, &#123;<span class="string">&quot;user_approval&quot;</span>: user_approval&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 继续执行图</span></span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.stream(<span class="literal">None</span>, config, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">            all_chunks.append(chunk)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 显示最终模型的响应</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;人工智能助理：&quot;</span>, all_chunks[-<span class="number">1</span>][<span class="string">&quot;model_response&quot;</span>].content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化配置和状态存储</span></span><br><span class="line">config = &#123;<span class="string">&quot;configurable&quot;</span>: &#123;<span class="string">&quot;thread_id&quot;</span>: <span class="string">&quot;3&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用该函数运行对话</span></span><br><span class="line">run_dialogue(graph, config)</span><br></pre></td></tr></table></figure>

<h1 id="10-Multi-Agent-Systems"><a href="#10-Multi-Agent-Systems" class="headerlink" title="10. Multi-Agent Systems"></a>10. Multi-Agent Systems</h1><h2 id="10-1-OpenAI对AI-Agent的理解"><a href="#10-1-OpenAI对AI-Agent的理解" class="headerlink" title="10.1 OpenAI对AI Agent的理解"></a>10.1 <code>OpenAI</code>对<code>AI Agent</code>的理解</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/a-1744965182810-1.png" alt="a"></p>
<h2 id="10-2-Single-Agent-架构的局限"><a href="#10-2-Single-Agent-架构的局限" class="headerlink" title="10.2 Single-Agent 架构的局限"></a>10.2 Single-Agent 架构的局限</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/b-1744965791891-3.png" alt="b"></p>
<p>当我们尝试处理更复杂任务时，单一 Agent 架构面临以下核心问题：</p>
<ul>
<li><strong>工具选择混乱</strong>：Agent 工具数量庞大时，容易做出错误决策。</li>
<li><strong>上下文复杂</strong>：难以清晰传递和跟踪关键信息。</li>
<li><strong>角色单一</strong>：难以胜任涉及多专业背景的任务。</li>
</ul>
<p>为应对上述问题，我们需要从「单体智能」转向「组织协作」——即多代理系统，其核心优势：</p>
<ol>
<li><strong>专业化</strong><br> 每个代理聚焦一个特定领域，提升整体系统处理能力。</li>
<li><strong>模块化</strong><br> 易于开发、测试和维护，每个模块可独立构建与更新。</li>
<li><strong>可控性</strong><br> 显式控制代理之间的通信，而非仅通过函数调用进行流程控制。</li>
</ol>
<p>如何实现多个 Agent 之间的通信？</p>
<ul>
<li><code>Single-Agent</code> 使用图结构中的节点和边构建流程；</li>
<li><code>Multi-Agent</code> 中则需定义 <strong>Agent 之间的通信路径与逻辑规则</strong>。</li>
</ul>
<h2 id="10-2-Multi-agent-architectures-架构"><a href="#10-2-Multi-agent-architectures-架构" class="headerlink" title="10.2 Multi-agent architectures 架构"></a>10.2 Multi-agent architectures 架构</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/d-1744965833176-5.png" alt="d"></p>
<ul>
<li>NetWork（网络）：每个代理都可以与其他每个代理通信。任何代理都可以决定接下来要呼叫哪个其他代理。</li>
<li>Supervisor（主管）：每个代理都与一个 <code>Supervisor</code> 代理通信。由 <code>Supervisor</code> 代理决定接下来应调用哪个代理。</li>
<li>Supervisor （tool-calling）： <code>Supervisor</code> 架构的一个特例。每个代理都是一个工具。由<code>Supervisor</code>代理通过工具调用的方式来决定调用哪些子代理执行任务，以及要传递给这些代理程序的参数</li>
<li>Hierarchical（分层）：定义具有 <code>supervisor</code> 嵌套 <code>supervisor</code>多代理系统。这是 <code>Supervisor</code> 架构的一种泛化，允许更复杂的控制流。</li>
</ul>
<h2 id="10-3-Subgraphs"><a href="#10-3-Subgraphs" class="headerlink" title="10.3 Subgraphs"></a>10.3 Subgraphs</h2><p>&emsp;&emsp;当把每个独立的<code>Agent</code>图结构定义为一个子图时，只要遵守子图的接口（输入和输出模式）规范，那么子图中定义的共享状态就可以在父图中进行使用。添加子图主要解决的问题就是解决各<code>Single-Agent</code>之间的通信问题，即它们如何在图执行期间在彼此之间传递状态。这主要有两种情况：</p>
<ul>
<li><strong>父、子图的状态模式中有共同的键（通道）</strong></li>
</ul>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/g.png" alt="g"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入必要模块</span></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> SystemMessage, HumanMessage</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> START, StateGraph</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="comment"># 设置 API 密钥与 Base URL（请注意不要在生产环境中暴露密钥）</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化语言模型</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 定义父图状态 ------------------------</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    user_input: <span class="built_in">str</span>         <span class="comment"># 用户输入</span></span><br><span class="line">    final_answer: <span class="built_in">str</span>       <span class="comment"># 模型最终回复</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 父图中用于处理用户输入的节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parent_node</span>(<span class="params">state: ParentState</span>):</span><br><span class="line">    response = llm.invoke(state[<span class="string">&quot;user_input&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_answer&quot;</span>: response&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 定义子图状态 ------------------------</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SubgraphState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    final_answer: <span class="built_in">str</span>       <span class="comment"># 父图传入的内容</span></span><br><span class="line">    summary_answer: <span class="built_in">str</span>     <span class="comment"># 子图中生成的摘要</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子图第一个节点：对父图内容进行摘要</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">subgraph_node_1</span>(<span class="params">state: SubgraphState</span>):</span><br><span class="line">    system_prompt = <span class="string">&quot;Please summary the content you receive to 50 words or less&quot;</span></span><br><span class="line">    messages = [SystemMessage(content=system_prompt), HumanMessage(content=state[<span class="string">&#x27;final_answer&#x27;</span>].content)]</span><br><span class="line">    response = llm.invoke(messages)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;summary_answer&quot;</span>: response&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子图第二个节点：对全文与摘要进行评分</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">subgraph_node_2</span>(<span class="params">state: SubgraphState</span>):</span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This is the full content of what you received：<span class="subst">&#123;state[<span class="string">&quot;final_answer&quot;</span>]&#125;</span> \n</span></span><br><span class="line"><span class="string">    This information is summarized for the full content:<span class="subst">&#123;state[<span class="string">&quot;summary_answer&quot;</span>]&#125;</span> </span></span><br><span class="line"><span class="string">    Please rate the text and summary information, returning a scale of 1 to 10. Note: Only the score value needs to be returned.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    response = llm.invoke([HumanMessage(content=prompt)])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_answer&quot;</span>: response.content&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 构建子图 ------------------------</span></span><br><span class="line">subgraph_builder = StateGraph(SubgraphState)</span><br><span class="line">subgraph_builder.add_node(subgraph_node_1)</span><br><span class="line">subgraph_builder.add_node(subgraph_node_2)</span><br><span class="line">subgraph_builder.add_edge(START, <span class="string">&quot;subgraph_node_1&quot;</span>)</span><br><span class="line">subgraph_builder.add_edge(<span class="string">&quot;subgraph_node_1&quot;</span>, <span class="string">&quot;subgraph_node_2&quot;</span>)</span><br><span class="line">subgraph = subgraph_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 构建父图 ------------------------</span></span><br><span class="line">builder = StateGraph(ParentState)</span><br><span class="line">builder.add_node(<span class="string">&quot;node_1&quot;</span>, parent_node)</span><br><span class="line">builder.add_node(<span class="string">&quot;node_2&quot;</span>, subgraph)  <span class="comment"># 将子图嵌入为父图的一个节点</span></span><br><span class="line">builder.add_edge(START, <span class="string">&quot;node_1&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;node_1&quot;</span>, <span class="string">&quot;node_2&quot;</span>)</span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------ 执行图流程（包含 stream 输出） ------------------------</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 示例一：用户提问大模型学习相关内容</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(&#123;<span class="string">&quot;user_input&quot;</span>: <span class="string">&quot;我现在想学习大模型，应该关注哪些技术？&quot;</span>&#125;, stream_mode=<span class="string">&#x27;values&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 示例二：用户提问 RAG 理解方式（如果想进一步查看子图的输出，可以在流式传输时指定 `subgraphs=True`）</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(&#123;<span class="string">&quot;user_input&quot;</span>: <span class="string">&quot;如何理解RAG？&quot;</span>&#125;, stream_mode=<span class="string">&#x27;values&#x27;</span>, subgraphs=<span class="literal">True</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动异步运行</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在这个图结构中，<code>final_answer</code>作为父图的全局共享状态，被<code>Sub Graph </code>子图访问。这个子图通过共享状态键<code>final_answer</code>进行交互，同时各自自己独立的内部状态键<code>summary_answer</code>。这种设计允许父图与子图之间通过共享状态键<code>final_answer</code>进行通信，同时保持各自的状态独立性，实现数据隔离与信息共享的平衡。</p>
</blockquote>
<ul>
<li><strong>父、子图的状态模式中没有共同的键（通道）</strong></li>
</ul>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/h.png" alt="h"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入模块</span></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> SystemMessage, HumanMessage</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> START, StateGraph</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 API 密钥和 Base URL</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化大模型实例</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义父图中的状态结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    user_input: <span class="built_in">str</span>           <span class="comment"># 用户的输入内容</span></span><br><span class="line">    final_answer: <span class="built_in">str</span>         <span class="comment"># 最终返回结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 父图中的第一个节点：将用户输入传给大模型</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parent_node_1</span>(<span class="params">state: ParentState</span>):</span><br><span class="line">    response = llm.invoke(state[<span class="string">&quot;user_input&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_answer&quot;</span>: response&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子图中的状态结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SubgraphState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    response_answer: <span class="built_in">str</span>      <span class="comment"># 接收父图传入的大模型响应</span></span><br><span class="line">    summary_answer: <span class="built_in">str</span>       <span class="comment"># 文本摘要结果</span></span><br><span class="line">    score: <span class="built_in">str</span>                <span class="comment"># 摘要评分结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子图中的第一个节点：生成摘要</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">subgraph_node_1</span>(<span class="params">state: SubgraphState</span>):</span><br><span class="line">    system_prompt = <span class="string">&quot;Please summary the content you receive to 50 words or less&quot;</span></span><br><span class="line">    messages = [SystemMessage(content=system_prompt), HumanMessage(content=state[<span class="string">&quot;response_answer&quot;</span>].content)]</span><br><span class="line">    response = llm.invoke(messages)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;summary_answer&quot;</span>: response&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子图中的第二个节点：根据原文+摘要生成评分</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">subgraph_node_2</span>(<span class="params">state: SubgraphState</span>):</span><br><span class="line">    content = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This is the full content of what you received：<span class="subst">&#123;state[<span class="string">&quot;response_answer&quot;</span>]&#125;</span> \n</span></span><br><span class="line"><span class="string">    This information is summarized for the full content:<span class="subst">&#123;state[<span class="string">&quot;summary_answer&quot;</span>]&#125;</span> </span></span><br><span class="line"><span class="string">    Please rate the text and summary information, returning a scale of 1 to 10. Note: Only the score value needs to be returned.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    response = llm.invoke([HumanMessage(content=content)])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;score&quot;</span>: response.content&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建子图流程</span></span><br><span class="line">subgraph_builder = StateGraph(SubgraphState)</span><br><span class="line">subgraph_builder.add_node(subgraph_node_1)</span><br><span class="line">subgraph_builder.add_node(subgraph_node_2)</span><br><span class="line">subgraph_builder.add_edge(START, <span class="string">&quot;subgraph_node_1&quot;</span>)</span><br><span class="line">subgraph_builder.add_edge(<span class="string">&quot;subgraph_node_1&quot;</span>, <span class="string">&quot;subgraph_node_2&quot;</span>)</span><br><span class="line">subgraph = subgraph_builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 父图中的第二个节点：调用子图，获取摘要评分</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parent_node_2</span>(<span class="params">state: ParentState</span>):</span><br><span class="line">    response = subgraph.invoke(&#123;<span class="string">&quot;response_answer&quot;</span>: state[<span class="string">&quot;final_answer&quot;</span>]&#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;final_answer&quot;</span>: response[<span class="string">&quot;score&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建父图流程</span></span><br><span class="line">builder = StateGraph(ParentState)</span><br><span class="line">builder.add_node(<span class="string">&quot;node_1&quot;</span>, parent_node_1)</span><br><span class="line">builder.add_node(<span class="string">&quot;node_2&quot;</span>, parent_node_2)</span><br><span class="line">builder.add_edge(START, <span class="string">&quot;node_1&quot;</span>)</span><br><span class="line">builder.add_edge(<span class="string">&quot;node_1&quot;</span>, <span class="string">&quot;node_2&quot;</span>)</span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义异步主函数运行流程</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 运行父图流程：学习大模型推荐技术方向</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(&#123;<span class="string">&quot;user_input&quot;</span>: <span class="string">&quot;我现在想学习大模型，应该关注哪些技术？&quot;</span>&#125;, stream_mode=<span class="string">&#x27;values&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(chunk)</span><br><span class="line">        <span class="comment"># 输出示例：&#123;&#x27;final_answer&#x27;: &#x27;8&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 运行父图并启用子图追踪：解释机器学习</span></span><br><span class="line">    all_chunk = []</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> graph.astream(&#123;<span class="string">&quot;user_input&quot;</span>: <span class="string">&quot;什么是机器学习？&quot;</span>&#125;, stream_mode=<span class="string">&#x27;values&#x27;</span>, subgraphs=<span class="literal">True</span>):</span><br><span class="line">        all_chunk.append(chunk)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(all_chunk[-<span class="number">1</span>][<span class="number">1</span>][<span class="string">&quot;final_answer&quot;</span>])</span><br><span class="line">    <span class="comment"># 输出示例：8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动异步任务</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在上面的案例中，<code>subgraph state</code> 完全独立于父 <code>graph state</code>，即两者之间没有重叠的键（通道）是最常见的，也是灵活性最高的。其中的关键点在于：<strong>需要在调用子图之前将其输入转换为子图，然后在返回之前转换其输出</strong>，即可正常完成父、子图之间的通信。</p>
</blockquote>
<h2 id="10-4-基于-Network-（网络）的多代理架构"><a href="#10-4-基于-Network-（网络）的多代理架构" class="headerlink" title="10.4 基于 Network （网络）的多代理架构"></a>10.4 基于 Network （网络）的多代理架构</h2><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/i.png" alt="i"></p>
<h2 id="10-5-Supervisor-多代理架构"><a href="#10-5-Supervisor-多代理架构" class="headerlink" title="10.5 Supervisor 多代理架构"></a>10.5 Supervisor 多代理架构</h2><h3 id="10-5-1-Magentic-One"><a href="#10-5-1-Magentic-One" class="headerlink" title="10.5.1 Magentic-One"></a>10.5.1 Magentic-One</h3><p>&emsp;&emsp;<code>Magentic-One</code>底层是基于<code>AutoGen</code>而构建的，是 <code>Microsoft</code> 推出的一种<strong>新的通用多代理系统， 同时也是一个基于多智能体 <code>AI</code> 的解决方案</strong>。<code>Magentic-One</code> 此次发布了 5 个默认智能代理，架构组成如下：</p>
<ul>
<li>高级代理 <code>Orchestrator</code>：负责高级规划和任务管理的核心组件。它可以指导其他代理，跟踪进度，并在进度停滞时重新规划。</li>
<li>四个专业代理支持<code>Orchestrator</code>调度，分别是：<ul>
<li>WebSurfer（网络代理）：管理用于导航和与网页交互的 Web 浏览器。 它可以基于 Chromium 浏览器运行，执行网页搜索、点击以及输入和汇总网页内容。</li>
<li>FileSurfer（文件代理）：处理本地文件管理和导航，基于 markdown 的文件预览应用程序读取本地文件。</li>
<li>Coder（编码代理）： 专门从事编写和分析代码。</li>
<li>ComputerTerminal（PC代理）：提供用于执行程序和安装库的控制台访问权限（即Shell控制台）。</li>
</ul>
</li>
</ul>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/1-1745030623191-12.png" alt="1"></p>
<p>&emsp;&emsp;这是一个具体的用户任务在<code>Magentic-One </code>中的执行过程：</p>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/2-1745030648400-14.png" alt="2"></p>
<blockquote>
<p>&emsp;&emsp;任务需求：<code>Orchestrator</code> 收到一个任务，用于在一个图像中提取 <code>Python</code> 代码，运行<code>Python</code>代码，处理一系列字符串，输出是一个<code>URL</code>，其中包含<code>C++</code>源代码，需要进一步编译并运行这段<code>C++</code>源代码后，返回第三和第五个整数的和。<code>Orchestrator</code> 通过以下步骤进行管理和协调完成该复杂任务：</p>
<ul>
<li>第 1 步：<code>FileSurfer</code> 代理访问图像，提取 <code>Python</code> 代码。</li>
<li>第 2 步：<code>Coder</code> 代理分析 <code>Python</code> 代码。</li>
<li>第 3 步：<code>ComputerTerminal</code> 执行 <code>Python</code> 代码，为 <code>C++</code> 代码生成 <code>URL</code>。</li>
<li>第 4 步： <code>WebSurfer</code> 访问 <code>URL</code> 并提取 <code>C++</code> 代码。</li>
<li>第 5 步：另一个 <code>Coder</code> 代理分析 <code>C++</code> 代码。</li>
<li>第 6 步： <code>ComputerTerminal</code> 代理执行 <code>C++</code> 代码，计算并返回最终结果，完成任务。</li>
</ul>
</blockquote>
<h3 id="10-5-2-Supervisor-架构介绍"><a href="#10-5-2-Supervisor-架构介绍" class="headerlink" title="10.5.2 Supervisor 架构介绍"></a>10.5.2 Supervisor 架构介绍</h3><p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/3-1745031055730-16.png" alt="3"></p>
<ul>
<li><p>将<strong>代理（agent）定义为节点</strong>。</p>
</li>
<li><p>添加一个**<code>supervisor</code>节点**，负责决策下一步应调用哪些代理节点。</p>
</li>
<li><p>使用<strong>条件边（conditional edges）</strong>，根据 <code>supervisor</code> 的判断，将执行流程路由至合适的代理。</p>
</li>
<li><p><strong>自言自语问题</strong>：</p>
<ul>
<li><code>supervisor</code> 频繁将代理输出返回给自己，造成冗余处理。</li>
<li>导致 <strong>运行时间变长</strong> 和 <strong>Token 消耗增加</strong>。</li>
</ul>
</li>
<li><p><strong>幻觉问题（Hallucination）</strong>：</p>
<ul>
<li>决策时未选择最优代理，而选择了不合适的路径，造成错误响应。</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入所需模块</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span>, <span class="type">Optional</span>, Annotated, <span class="type">Literal</span></span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String, Float, ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, declarative_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> AnyMessage, SystemMessage, HumanMessage, ToolMessage</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_experimental.utilities <span class="keyword">import</span> PythonREPL</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, MessagesState, START, END</span><br><span class="line"><span class="keyword">from</span> langgraph.prebuilt <span class="keyword">import</span> create_react_agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 LLM 设置</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, api_key=key, base_url=base_url, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化数据库连接</span></span><br><span class="line">Base = declarative_base()</span><br><span class="line">DATABASE_URI = <span class="string">&#x27;sqlite:///langgraphbi.db&#x27;</span></span><br><span class="line">engine = create_engine(DATABASE_URI)</span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库表模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SalesData</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;sales_data&#x27;</span></span><br><span class="line">    sales_id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    product_id = Column(Integer, ForeignKey(<span class="string">&#x27;product_information.product_id&#x27;</span>))</span><br><span class="line">    employee_id = Column(Integer)</span><br><span class="line">    customer_id = Column(Integer, ForeignKey(<span class="string">&#x27;customer_information.customer_id&#x27;</span>))</span><br><span class="line">    sale_date = Column(String(<span class="number">50</span>))</span><br><span class="line">    quantity = Column(Integer)</span><br><span class="line">    amount = Column(Float)</span><br><span class="line">    discount = Column(Float)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerInformation</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;customer_information&#x27;</span></span><br><span class="line">    customer_id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    customer_name = Column(String(<span class="number">50</span>))</span><br><span class="line">    contact_info = Column(String(<span class="number">50</span>))</span><br><span class="line">    region = Column(String(<span class="number">50</span>))</span><br><span class="line">    customer_type = Column(String(<span class="number">50</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductInformation</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;product_information&#x27;</span></span><br><span class="line">    product_id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    product_name = Column(String(<span class="number">50</span>))</span><br><span class="line">    category = Column(String(<span class="number">50</span>))</span><br><span class="line">    unit_price = Column(Float)</span><br><span class="line">    stock_level = Column(Integer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CompetitorAnalysis</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;competitor_analysis&#x27;</span></span><br><span class="line">    competitor_id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    competitor_name = Column(String(<span class="number">50</span>))</span><br><span class="line">    region = Column(String(<span class="number">50</span>))</span><br><span class="line">    market_share = Column(Float)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义工具函数的输入模式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddSaleSchema</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    product_id: <span class="built_in">int</span></span><br><span class="line">    employee_id: <span class="built_in">int</span></span><br><span class="line">    customer_id: <span class="built_in">int</span></span><br><span class="line">    sale_date: <span class="built_in">str</span></span><br><span class="line">    quantity: <span class="built_in">int</span></span><br><span class="line">    amount: <span class="built_in">float</span></span><br><span class="line">    discount: <span class="built_in">float</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DeleteSaleSchema</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    sales_id: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UpdateSaleSchema</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    sales_id: <span class="built_in">int</span></span><br><span class="line">    quantity: <span class="built_in">int</span></span><br><span class="line">    amount: <span class="built_in">float</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QuerySalesSchema</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    sales_id: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加销售记录工具</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=AddSaleSchema</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_sale</span>(<span class="params">product_id, employee_id, customer_id, sale_date, quantity, amount, discount</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;添加销售记录到数据库&quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        new_sale = SalesData(</span><br><span class="line">            product_id=product_id,</span><br><span class="line">            employee_id=employee_id,</span><br><span class="line">            customer_id=customer_id,</span><br><span class="line">            sale_date=sale_date,</span><br><span class="line">            quantity=quantity,</span><br><span class="line">            amount=amount,</span><br><span class="line">            discount=discount</span><br><span class="line">        )</span><br><span class="line">        session.add(new_sale)</span><br><span class="line">        session.commit()</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;销售记录添加成功。&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;添加失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除销售记录工具</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=DeleteSaleSchema</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_sale</span>(<span class="params">sales_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从数据库中删除销售记录&quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sale_to_delete = session.query(SalesData).<span class="built_in">filter</span>(SalesData.sales_id == sales_id).first()</span><br><span class="line">        <span class="keyword">if</span> sale_to_delete:</span><br><span class="line">            session.delete(sale_to_delete)</span><br><span class="line">            session.commit()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;销售记录删除成功。&quot;</span>]&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;未找到销售记录ID：<span class="subst">&#123;sales_id&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;删除失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新销售记录工具</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=UpdateSaleSchema</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_sale</span>(<span class="params">sales_id, quantity, amount</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;更新数据库中的销售记录&quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sale_to_update = session.query(SalesData).<span class="built_in">filter</span>(SalesData.sales_id == sales_id).first()</span><br><span class="line">        <span class="keyword">if</span> sale_to_update:</span><br><span class="line">            sale_to_update.quantity = quantity</span><br><span class="line">            sale_to_update.amount = amount</span><br><span class="line">            session.commit()</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">&quot;销售记录更新成功。&quot;</span>]&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;未找到销售记录ID：<span class="subst">&#123;sales_id&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;更新失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询销售记录工具</span></span><br><span class="line"><span class="meta">@tool(<span class="params">args_schema=QuerySalesSchema</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_sales</span>(<span class="params">sales_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据 ID 查询销售记录&quot;&quot;&quot;</span></span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sale_data = session.query(SalesData).<span class="built_in">filter</span>(SalesData.sales_id == sales_id).first()</span><br><span class="line">        <span class="keyword">if</span> sale_data:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;sales_id&quot;</span>: sale_data.sales_id,</span><br><span class="line">                <span class="string">&quot;product_id&quot;</span>: sale_data.product_id,</span><br><span class="line">                <span class="string">&quot;employee_id&quot;</span>: sale_data.employee_id,</span><br><span class="line">                <span class="string">&quot;customer_id&quot;</span>: sale_data.customer_id,</span><br><span class="line">                <span class="string">&quot;sale_date&quot;</span>: sale_data.sale_date,</span><br><span class="line">                <span class="string">&quot;quantity&quot;</span>: sale_data.quantity,</span><br><span class="line">                <span class="string">&quot;amount&quot;</span>: sale_data.amount,</span><br><span class="line">                <span class="string">&quot;discount&quot;</span>: sale_data.discount</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;未找到销售记录ID：<span class="subst">&#123;sales_id&#125;</span>。&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [<span class="string">f&quot;查询失败，错误原因：<span class="subst">&#123;e&#125;</span>&quot;</span>]&#125;</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python 执行器</span></span><br><span class="line">repl = PythonREPL()</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">python_repl</span>(<span class="params">code: Annotated[<span class="built_in">str</span>, <span class="string">&quot;The python code to execute to generate your chart.&quot;</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;执行 Python 代码，常用于生成图表等&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = repl.run(code)</span><br><span class="line">    <span class="keyword">except</span> BaseException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Failed to execute. Error: <span class="subst">&#123;<span class="built_in">repr</span>(e)&#125;</span>&quot;</span></span><br><span class="line">    result_str = <span class="string">f&quot;Successfully executed:\n```python\n<span class="subst">&#123;code&#125;</span>\n```\nStdout: <span class="subst">&#123;result&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> result_str</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建两个智能体：数据库操作智能体、Python 执行智能体</span></span><br><span class="line">db_agent = create_react_agent(</span><br><span class="line">    llm,</span><br><span class="line">    tools=[add_sale, delete_sale, update_sale, query_sales],</span><br><span class="line">    state_modifier=<span class="string">&quot;You use to perform database operations while should provide accurate data for the code_generator to use&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">code_agent = create_react_agent(</span><br><span class="line">    llm,</span><br><span class="line">    tools=[python_repl],</span><br><span class="line">    state_modifier=<span class="string">&quot;Run python code to display diagrams or output execution results&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义代理系统状态结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">MessagesState</span>):</span><br><span class="line">    <span class="built_in">next</span>: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库智能体节点逻辑</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">db_node</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    result = db_agent.invoke(state)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">            HumanMessage(content=result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content, name=<span class="string">&quot;sqler&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义代码执行智能体节点逻辑</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">code_node</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    result = code_agent.invoke(state)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">            HumanMessage(content=result[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].content, name=<span class="string">&quot;coder&quot;</span>)</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 Supervisor 的动作选择输出结构</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Router</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    <span class="built_in">next</span>: <span class="type">Literal</span>[<span class="string">&quot;chat&quot;</span>, <span class="string">&quot;coder&quot;</span>, <span class="string">&quot;sqler&quot;</span>, <span class="string">&quot;FINISH&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Supervisor 决定下一个要调用的智能体</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">supervisor</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    system_prompt = (</span><br><span class="line">        <span class="string">&quot;You are a supervisor tasked with managing a conversation between the&quot;</span></span><br><span class="line">        <span class="string">f&quot; following workers: <span class="subst">&#123;members&#125;</span>.\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Each worker has a specific role:\n&quot;</span></span><br><span class="line">        <span class="string">&quot;- chat: Responds directly to user inputs using natural language.\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Given the following user request, respond with the worker to act next.&quot;</span></span><br><span class="line">        <span class="string">&quot; Each worker will perform a task and respond with their results and status.&quot;</span></span><br><span class="line">        <span class="string">&quot; When finished, respond with FINISH.&quot;</span></span><br><span class="line">    )</span><br><span class="line">    messages = [&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_prompt&#125;] + state[<span class="string">&quot;messages&quot;</span>]</span><br><span class="line">    response = llm.with_structured_output(Router).invoke(messages)</span><br><span class="line">    next_ = response[<span class="string">&quot;next&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> next_ == <span class="string">&quot;FINISH&quot;</span>:</span><br><span class="line">        next_ = END</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;next&quot;</span>: next_&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># chat 节点智能体</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chat</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    messages = state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line">    model_response = llm.invoke(messages.content)</span><br><span class="line">    final_response = [HumanMessage(content=model_response.content, name=<span class="string">&quot;chat&quot;</span>)]</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: final_response&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建完整图</span></span><br><span class="line">members = [<span class="string">&quot;chat&quot;</span>, <span class="string">&quot;coder&quot;</span>, <span class="string">&quot;sqler&quot;</span>]</span><br><span class="line">builder = StateGraph(AgentState)</span><br><span class="line">builder.add_node(<span class="string">&quot;supervisor&quot;</span>, supervisor)</span><br><span class="line">builder.add_node(<span class="string">&quot;chat&quot;</span>, chat)</span><br><span class="line">builder.add_node(<span class="string">&quot;coder&quot;</span>, code_node)</span><br><span class="line">builder.add_node(<span class="string">&quot;sqler&quot;</span>, db_node)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> member <span class="keyword">in</span> members:</span><br><span class="line">    builder.add_edge(member, <span class="string">&quot;supervisor&quot;</span>)</span><br><span class="line"></span><br><span class="line">builder.add_conditional_edges(<span class="string">&quot;supervisor&quot;</span>, <span class="keyword">lambda</span> state: state[<span class="string">&quot;next&quot;</span>])</span><br><span class="line">builder.add_edge(START, <span class="string">&quot;supervisor&quot;</span>)</span><br><span class="line"></span><br><span class="line">graph = builder.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 流式运行示例 1：查询销售记录</span></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;messages&quot;</span>: <span class="string">&quot;帮我查询前3个销售记录的具体信息&quot;</span>&#125;, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">    <span class="built_in">print</span>(chunk)</span><br><span class="line">    <span class="comment"># 示例输出: &#123;&#x27;messages&#x27;: [...], &#x27;next&#x27;: &#x27;supervisor&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 流式运行示例 2：生成柱状图</span></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;messages&quot;</span>: <span class="string">&quot;帮我根据前10名的 销售记录id，生成对应的销售额柱状图&quot;</span>&#125;, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">    <span class="built_in">print</span>(chunk)</span><br><span class="line">    <span class="comment"># 示例输出: &#123;&#x27;messages&#x27;: [...], &#x27;next&#x27;: &#x27;supervisor&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 流式运行示例 3：普通对话</span></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> graph.stream(&#123;<span class="string">&quot;messages&quot;</span>: <span class="string">&quot;你好，什么是机器学习？&quot;</span>&#125;, stream_mode=<span class="string">&quot;values&quot;</span>):</span><br><span class="line">    chunk[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>].pretty_print()</span><br><span class="line">    <span class="comment"># 示例输出: chat: 机器学习是一种使计算机系统能从数据中学习并做出预测的技术...</span></span><br></pre></td></tr></table></figure>

<h2 id="10-6-Multi-Agent实现混合多知识库检索"><a href="#10-6-Multi-Agent实现混合多知识库检索" class="headerlink" title="10.6 Multi-Agent实现混合多知识库检索"></a>10.6 Multi-Agent实现混合多知识库检索</h2><h3 id="10-6-1-GraphRAG-基本介绍"><a href="#10-6-1-GraphRAG-基本介绍" class="headerlink" title="10.6.1 GraphRAG 基本介绍"></a>10.6.1 GraphRAG 基本介绍</h3><ol>
<li><strong>传统 RAG 的优势：</strong></li>
</ol>
<ul>
<li>能快速检索简单问题的答案。</li>
<li>降低大模型的“幻觉”风险。</li>
<li>适合基于具体查询的高效文档搜索。</li>
</ul>
<ol start="2">
<li><strong>传统 RAG 的局限性：</strong></li>
</ol>
<ul>
<li>检索基于<strong>语义相似性</strong>但高度依赖<strong>查询质量</strong>。</li>
<li>无法处理跨多个文档的综合推理或复杂问答。</li>
<li>容易出现以下问题：<ul>
<li>文本块间上下文缺失。</li>
<li>检索文档数量增多后性能下降。</li>
<li>整合外部知识过程混乱、缺乏结构。</li>
</ul>
</li>
</ul>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/4.png" alt="4"></p>
<ol start="3">
<li><strong>GraphRAG 的核心优势</strong></li>
</ol>
<ul>
<li><strong>结构化检索</strong>：基于知识图谱表示信息，替代无结构文本片段。</li>
<li><strong>上下文融合能力强</strong>：能跨文档连接实体关系，构建更完整语义网络。</li>
<li><strong>适用于复杂问答与多步推理</strong>：不仅仅是相似度匹配，而是进行逻辑、语义关联。</li>
</ul>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/5-1745052464875-19.png" alt="5"></p>
<p><img src="/images/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/6-1745052507580-21.png" alt="6"></p>
<h3 id="10-6-2-GraphRAG"><a href="#10-6-2-GraphRAG" class="headerlink" title="10.6.2 GraphRAG"></a>10.6.2 GraphRAG</h3><ol>
<li><strong>配置 Neo4j 图数据库实例</strong></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://console.neo4j.io/?product=aura-db&tenant=2afe251b-59ae-5517-9598-84fc5d57b0b5">https://console.neo4j.io/?product=aura-db&amp;tenant=2afe251b-59ae-5517-9598-84fc5d57b0b5</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> GraphCypherQAChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.graphs <span class="keyword">import</span> Neo4jGraph</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_experimental.graph_transformers <span class="keyword">import</span> LLMGraphTransformer</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;company.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    <span class="comment"># 读取文件的全部内容</span></span><br><span class="line">    content = file.read()</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line">documents = [Document(page_content=content)]</span><br><span class="line"></span><br><span class="line">graph = Neo4jGraph(url=<span class="string">&#x27;neo4j+s://a230d07c.databases.neo4j.io&#x27;</span>,  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   username=<span class="string">&quot;neo4j&quot;</span>,  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   password=<span class="string">&quot;your_password&quot;</span>,  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   database=<span class="string">&quot;neo4j&quot;</span>  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   )</span><br><span class="line"></span><br><span class="line">graph_llm = ChatOpenAI(model=<span class="string">&quot;gpt-4o&quot;</span>, api_key=key, base_url=base_url)</span><br><span class="line"></span><br><span class="line">graph_transformer = LLMGraphTransformer(</span><br><span class="line">    llm=graph_llm,</span><br><span class="line">    allowed_nodes=[<span class="string">&quot;公司&quot;</span>, <span class="string">&quot;产品&quot;</span>, <span class="string">&quot;技术&quot;</span>, <span class="string">&quot;市场&quot;</span>, <span class="string">&quot;活动&quot;</span>, <span class="string">&quot;合作伙伴&quot;</span>],  <span class="comment"># 可以自定义节点</span></span><br><span class="line">    allowed_relationships=[<span class="string">&quot;推出&quot;</span>, <span class="string">&quot;参与&quot;</span>, <span class="string">&quot;合作&quot;</span>, <span class="string">&quot;位于&quot;</span>, <span class="string">&quot;开发&quot;</span>],  <span class="comment"># 可以自定义关系</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">graph_transformer = LLMGraphTransformer(llm=graph_llm)</span><br><span class="line"></span><br><span class="line">graph_documents = graph_transformer.convert_to_graph_documents(documents)</span><br><span class="line"></span><br><span class="line">graph.add_graph_documents(graph_documents)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Graph documents: <span class="subst">&#123;<span class="built_in">len</span>(graph_documents)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Nodes from 1st graph doc:<span class="subst">&#123;graph_documents[<span class="number">0</span>].nodes&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Relationships from 1st graph doc:<span class="subst">&#123;graph_documents[<span class="number">0</span>].relationships&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI(model_name=<span class="string">&quot;gpt-4o&quot;</span>, api_key=key, base_url=base_url)</span><br><span class="line"></span><br><span class="line">cypher_chain = GraphCypherQAChain.from_llm(</span><br><span class="line">    graph=graph,</span><br><span class="line">    cypher_llm=llm,</span><br><span class="line">    qa_llm=llm,</span><br><span class="line">    validate_cypher=<span class="literal">True</span>,  <span class="comment"># Validate relationship directions</span></span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    allow_dangerous_requests=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line">cypher_chain.invoke(<span class="string">&quot;苹果公司开发了什么？&quot;</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>封装成多代理系统中的一个工具</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> GraphCypherQAChain</span><br><span class="line"><span class="keyword">from</span> langchain_community.graphs <span class="keyword">import</span> Neo4jGraph</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> MessagesState</span><br><span class="line"></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line">graph = Neo4jGraph(url=<span class="string">&#x27;neo4j+s://a230d07c.databases.neo4j.io&#x27;</span>,  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   username=<span class="string">&quot;neo4j&quot;</span>,  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   password=<span class="string">&quot;your_password&quot;</span>,  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   database=<span class="string">&quot;neo4j&quot;</span>  <span class="comment"># 替换为自己的</span></span><br><span class="line">                   )</span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI(model_name=<span class="string">&quot;gpt-4o&quot;</span>, api_key=key, base_url=base_url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">MessagesState</span>):</span><br><span class="line">    <span class="built_in">next</span>: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">graph_kg</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    messages = state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line">    cypher_chain = GraphCypherQAChain.from_llm(</span><br><span class="line">        graph=graph,</span><br><span class="line">        cypher_llm=llm,</span><br><span class="line">        qa_llm=llm,</span><br><span class="line">        validate_cypher=<span class="literal">True</span>,</span><br><span class="line">        allow_dangerous_requests=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line">    response = cypher_chain.invoke(messages.content)</span><br><span class="line">    final_response = [HumanMessage(content=response[<span class="string">&quot;result&quot;</span>], name=<span class="string">&quot;graph_kg&quot;</span>)]  <span class="comment"># 这里要添加名称</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: final_response&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10-6-3-传统-RAG-Agent"><a href="#10-6-3-传统-RAG-Agent" class="headerlink" title="10.6.3 传统 RAG Agent"></a>10.6.3 传统 RAG Agent</h3><p><a target="_blank" rel="noopener" href="https://cloud.zilliz.com/login?redirect=/orgs">https://cloud.zilliz.com/login?redirect=/orgs</a></p>
<ol>
<li><strong>配置milvus</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入必要模块</span></span><br><span class="line"><span class="keyword">from</span> langchain_community.graphs <span class="keyword">import</span> Neo4jGraph</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI, OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_milvus <span class="keyword">import</span> Milvus</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> MessagesState</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 OpenAI 接口密钥和代理地址</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取文本内容作为知识文档</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;company.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    content = file.read()</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line">    <span class="comment"># 示例输出：显示 company.txt 文件的全部文本内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 LangChain 的 Document 对象</span></span><br><span class="line">documents = [Document(page_content=content)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 OpenAI LLM（GPT-4o）</span></span><br><span class="line">graph_llm = ChatOpenAI(model=<span class="string">&quot;gpt-4o&quot;</span>, api_key=key, base_url=base_url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置文本分割器，将长文本划分为多个小块</span></span><br><span class="line">chunk_size = <span class="number">250</span></span><br><span class="line">chunk_overlap = <span class="number">30</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter(</span><br><span class="line">    chunk_size=chunk_size,</span><br><span class="line">    chunk_overlap=chunk_overlap</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分割文档</span></span><br><span class="line">splits = text_splitter.split_documents(documents)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化向量嵌入模型</span></span><br><span class="line">embeddings = OpenAIEmbeddings(</span><br><span class="line">    model=<span class="string">&quot;text-embedding-3-large&quot;</span>,</span><br><span class="line">    api_key=key,</span><br><span class="line">    base_url=base_url</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 Milvus 向量数据库并添加文档</span></span><br><span class="line">vectorstore = Milvus.from_documents(</span><br><span class="line">    documents=splits,</span><br><span class="line">    collection_name=<span class="string">&quot;company_milvus&quot;</span>,</span><br><span class="line">    embedding=embeddings,</span><br><span class="line">    connection_args=&#123;</span><br><span class="line">        <span class="string">&quot;uri&quot;</span>: <span class="string">&quot;https://in03-7088091b091a7b8.serverless.gcp-us-west1.cloud.zilliz.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user&quot;</span>: <span class="string">&quot;db_7088091b091a7b8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;your_password&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 QA 提示模板</span></span><br><span class="line">prompt = PromptTemplate(</span><br><span class="line">    template=<span class="string">&quot;&quot;&quot;You are an assistant for question-answering tasks. </span></span><br><span class="line"><span class="string">Use the following pieces of retrieved context to answer the question. If you don&#x27;t know the answer, just say that you don&#x27;t know. </span></span><br><span class="line"><span class="string">Use three sentences maximum and keep the answer concise:</span></span><br><span class="line"><span class="string">Question: &#123;question&#125; </span></span><br><span class="line"><span class="string">Context: &#123;context&#125; </span></span><br><span class="line"><span class="string">Answer:&quot;&quot;&quot;</span>,</span><br><span class="line">    input_variables=[<span class="string">&quot;question&quot;</span>, <span class="string">&quot;document&quot;</span>],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 RAG QA Chain</span></span><br><span class="line">rag_chain = prompt | graph_llm | StrOutputParser()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置问题内容</span></span><br><span class="line">question = <span class="string">&quot;我的知识库中都有哪些公司信息&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建检索器（top-1）</span></span><br><span class="line">retriever = vectorstore.as_retriever(search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行检索</span></span><br><span class="line">docs = retriever.invoke(<span class="string">&quot;question&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用 LLM 获取答案</span></span><br><span class="line">generation = rag_chain.invoke(&#123;<span class="string">&quot;context&quot;</span>: docs, <span class="string">&quot;question&quot;</span>: question&#125;)</span><br><span class="line"><span class="built_in">print</span>(generation)</span><br><span class="line"><span class="comment"># 示例输出：如 &quot;根据知识库，目前包含的公司有小麦智能、智源科技等。&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>封装成多代理系统中的一个工具</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入必要模块</span></span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_core.messages <span class="keyword">import</span> HumanMessage</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_milvus <span class="keyword">import</span> Milvus</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI, OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_text_splitters <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> MessagesState</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 OpenAI 接口密钥和代理地址</span></span><br><span class="line">key = <span class="string">&quot;your_key&quot;</span></span><br><span class="line">base_url = <span class="string">&quot;your_url&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取文本内容作为知识文档</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;company.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    content = file.read()</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line">    <span class="comment"># 示例输出：显示 company.txt 文件的全部文本内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 LangChain 的 Document 对象</span></span><br><span class="line">documents = [Document(page_content=content)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 OpenAI LLM（GPT-4o）</span></span><br><span class="line">graph_llm = ChatOpenAI(model=<span class="string">&quot;gpt-4o&quot;</span>, api_key=key, base_url=base_url)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置文本分割器，将长文本划分为多个小块</span></span><br><span class="line">chunk_size = <span class="number">250</span></span><br><span class="line">chunk_overlap = <span class="number">30</span></span><br><span class="line">text_splitter = RecursiveCharacterTextSplitter(</span><br><span class="line">    chunk_size=chunk_size,</span><br><span class="line">    chunk_overlap=chunk_overlap</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分割文档</span></span><br><span class="line">splits = text_splitter.split_documents(documents)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化向量嵌入模型</span></span><br><span class="line">embeddings = OpenAIEmbeddings(</span><br><span class="line">    model=<span class="string">&quot;text-embedding-3-large&quot;</span>,</span><br><span class="line">    api_key=key,</span><br><span class="line">    base_url=base_url</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 Milvus 向量数据库并添加文档</span></span><br><span class="line">vectorstore = Milvus.from_documents(</span><br><span class="line">    documents=splits,</span><br><span class="line">    collection_name=<span class="string">&quot;company_milvus&quot;</span>,</span><br><span class="line">    embedding=embeddings,</span><br><span class="line">    connection_args=&#123;</span><br><span class="line">        <span class="string">&quot;uri&quot;</span>: <span class="string">&quot;https://in03-7088091b091a7b8.serverless.gcp-us-west1.cloud.zilliz.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user&quot;</span>: <span class="string">&quot;db_7088091b091a7b8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;your_password&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 LangGraph 的 Agent 状态</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">MessagesState</span>):</span><br><span class="line">    <span class="built_in">next</span>: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个函数节点：基于向量数据库进行问答</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vec_kg</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    messages = state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line">    question = messages.content</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重新构建提示模板（可复用上方 prompt）</span></span><br><span class="line">    prompt = PromptTemplate(</span><br><span class="line">        template=<span class="string">&quot;&quot;&quot;You are an assistant for question-answering tasks. </span></span><br><span class="line"><span class="string">Use the following pieces of retrieved context to answer the question. If you don&#x27;t know the answer, just say that you don&#x27;t know. </span></span><br><span class="line"><span class="string">Use three sentences maximum and keep the answer concise:</span></span><br><span class="line"><span class="string">Question: &#123;question&#125; </span></span><br><span class="line"><span class="string">Context: &#123;context&#125; </span></span><br><span class="line"><span class="string">Answer:&quot;&quot;&quot;</span>,</span><br><span class="line">        input_variables=[<span class="string">&quot;question&quot;</span>, <span class="string">&quot;document&quot;</span>],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建 QA Chain</span></span><br><span class="line">    rag_chain = prompt | graph_llm | StrOutputParser()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建检索器</span></span><br><span class="line">    retriever = vectorstore.as_retriever(search_kwargs=&#123;<span class="string">&quot;k&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行检索 + 推理生成回答</span></span><br><span class="line">    docs = retriever.invoke(<span class="string">&quot;question&quot;</span>)</span><br><span class="line">    generation = rag_chain.invoke(&#123;<span class="string">&quot;context&quot;</span>: docs, <span class="string">&quot;question&quot;</span>: question&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构建最终响应消息，供 LangGraph 传递</span></span><br><span class="line">    final_response = [HumanMessage(content=generation, name=<span class="string">&quot;vec_kg&quot;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: final_response&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/hughnwj">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Agent%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">1. Agent概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Agent%E5%BC%80%E5%8F%91%E5%BD%93%E5%89%8D%E5%B0%AC%E5%B0%B4%E7%9A%84%E5%B1%80%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 Agent开发当前尬尴的局面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Agent%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 Agent开发框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%AD%A6%E4%B9%A0Agent%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6%E7%9A%848%E5%A4%A7%E8%A6%81%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 学习Agent开发框架的8大要点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-LangGraph-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">2. LangGraph 底层原理介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-LangGraph-%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E7%82%B9"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 LangGraph 的主要特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%B8%8E-LangChain-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 与 LangChain 的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%A0%B8%E5%BF%83%E4%BC%98%E5%8A%BF%E6%A6%82%E8%A7%88"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 核心优势概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E6%9C%BA%E5%88%B6"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 核心功能机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-LangGraph%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">3. LangGraph底层源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E7%AE%80%E5%8D%95Graph%E7%9A%84%E6%9E%84%E5%BB%BA"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 简单Graph的构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BD%BF%E7%94%A8LangGraph%E6%9E%84%E5%BB%BA%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%97%AE%E7%AD%94%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 使用LangGraph构建大模型的问答流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-State%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">4. State状态模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-State%E7%9A%84%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 State的定义模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Reducer%E5%87%BD%E6%95%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 Reducer函数机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MessageGraph-%E6%BA%90%E7%A0%81%E5%8A%9F%E8%83%BD%E8%A7%A3%E6%9E%90"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MessageGraph 源码功能解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-MessageGraph"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 MessageGraph</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-add-messages"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2  add_messages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-MessageGraph-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.3.3.</span> <span class="toc-text">4.3.3 MessageGraph 基本使用示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-4-add-messages-%E5%90%88%E5%B9%B6%E9%80%BB%E8%BE%91%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.3.4.</span> <span class="toc-text">4.3.4 add_messages 合并逻辑示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-5-MessageGraph-%E4%B8%8E-StateGraph-%E5%AF%B9%E6%AF%94"><span class="toc-number">4.3.5.</span> <span class="toc-text">4.3.5 MessageGraph 与 StateGraph 对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-StateGraph%E5%AE%9A%E4%B9%89%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 StateGraph定义聊天机器人</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-LangSmith"><span class="toc-number">5.</span> <span class="toc-text">5. LangSmith</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E5%8D%95%E4%BB%A3%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">6. 单代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E8%B7%AF%E7%94%B1%E4%BB%A3%E7%90%86"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 路由代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E6%9D%A1%E4%BB%B6%E8%BE%B9"><span class="toc-number">6.1.1.</span> <span class="toc-text">6.1.1 条件边</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA"><span class="toc-number">6.1.2.</span> <span class="toc-text">6.1.2 结构化输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E6%9E%84%E5%BB%BA%E8%B7%AF%E7%94%B1%E5%9B%BE"><span class="toc-number">6.1.3.</span> <span class="toc-text">6.1.3 构建路由图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E4%BB%A3%E7%90%86"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 工具调用代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-ReAct"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 ReAct</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E4%BA%8B%E4%BB%B6%E6%B5%81"><span class="toc-number">7.</span> <span class="toc-text">7. 事件流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-LangChain%E4%BA%8B%E4%BB%B6%E6%B5%81"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 LangChain事件流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-LangGraph%E4%BA%8B%E4%BB%B6%E6%B5%81"><span class="toc-number">7.2.</span> <span class="toc-text">7.2 LangGraph事件流</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E9%95%BF%E7%9F%AD%E6%9C%9F%E8%AE%B0%E5%BF%86"><span class="toc-number">8.</span> <span class="toc-text">8. 长短期记忆</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E7%8A%B6%E6%80%81%EF%BC%88State%EF%BC%89"><span class="toc-number">8.1.</span> <span class="toc-text">8.1 状态（State）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E8%AE%B0%E5%BF%86%E6%9C%BA%E5%88%B6"><span class="toc-number">8.2.</span> <span class="toc-text">8.2 记忆机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1-%E7%9F%AD%E6%9C%9F%E8%AE%B0%E5%BF%86%E4%B8%8E-Checkpointer%EF%BC%88%E6%A3%80%E6%9F%A5%E7%82%B9%EF%BC%89"><span class="toc-number">8.2.1.</span> <span class="toc-text">8.2.1 短期记忆与 Checkpointer（检查点）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-1-MemorySaver%EF%BC%88%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%EF%BC%8C%E9%80%82%E5%90%88%E5%AE%9E%E9%AA%8C%EF%BC%89"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">8.2.1.1 MemorySaver（内存存储，适合实验）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-2-SqliteSaver-AsyncSqliteSaver%EF%BC%88%E6%9C%AC%E5%9C%B0-SQLite-%E5%AD%98%E5%82%A8%EF%BC%89"><span class="toc-number">8.2.1.2.</span> <span class="toc-text">8.2.1.2 SqliteSaver &#x2F; AsyncSqliteSaver（本地 SQLite 存储）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-3-PostgresSaver-AsyncPostgresSaver%EF%BC%88%E7%94%9F%E4%BA%A7%E7%BA%A7%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%89"><span class="toc-number">8.2.1.3.</span> <span class="toc-text">8.1.2.3 PostgresSaver &#x2F; AsyncPostgresSaver（生产级持久化）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-4-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A3%80%E6%9F%A5%E7%82%B9%EF%BC%88Advanced%EF%BC%89"><span class="toc-number">8.2.1.4.</span> <span class="toc-text">8.1.2.4 自定义检查点（Advanced）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2-%E9%95%BF%E6%9C%9F%E8%AE%B0%E5%BF%86%E5%92%8CStore%EF%BC%88%E4%BB%93%E5%BA%93%EF%BC%89"><span class="toc-number">8.2.2.</span> <span class="toc-text">8.2.2 长期记忆和Store（仓库）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-Human-in-the-loop"><span class="toc-number">9.</span> <span class="toc-text">9. Human-in-the-loop</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E8%83%8C%E6%99%AF%E4%B8%8E%E9%9C%80%E6%B1%82"><span class="toc-number">9.1.</span> <span class="toc-text">9.1 背景与需求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-HIL-%E5%B8%B8%E8%A7%81%E4%BA%A4%E4%BA%92%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.2.</span> <span class="toc-text">9.2 HIL 常见交互模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E5%9C%A8-LangGraph-%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">9.3.</span> <span class="toc-text">9.3 在 LangGraph 中的实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">9.4.</span> <span class="toc-text">9.4 代码示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-%E5%A4%9A%E8%BD%AE%E5%AF%B9%E8%AF%9D%E5%B0%81%E8%A3%85%E7%A4%BA%E4%BE%8B"><span class="toc-number">9.5.</span> <span class="toc-text">9.5 多轮对话封装示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-Multi-Agent-Systems"><span class="toc-number">10.</span> <span class="toc-text">10. Multi-Agent Systems</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-OpenAI%E5%AF%B9AI-Agent%E7%9A%84%E7%90%86%E8%A7%A3"><span class="toc-number">10.1.</span> <span class="toc-text">10.1 OpenAI对AI Agent的理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-Single-Agent-%E6%9E%B6%E6%9E%84%E7%9A%84%E5%B1%80%E9%99%90"><span class="toc-number">10.2.</span> <span class="toc-text">10.2 Single-Agent 架构的局限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-Multi-agent-architectures-%E6%9E%B6%E6%9E%84"><span class="toc-number">10.3.</span> <span class="toc-text">10.2 Multi-agent architectures 架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-Subgraphs"><span class="toc-number">10.4.</span> <span class="toc-text">10.3 Subgraphs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E5%9F%BA%E4%BA%8E-Network-%EF%BC%88%E7%BD%91%E7%BB%9C%EF%BC%89%E7%9A%84%E5%A4%9A%E4%BB%A3%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">10.5.</span> <span class="toc-text">10.4 基于 Network （网络）的多代理架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-5-Supervisor-%E5%A4%9A%E4%BB%A3%E7%90%86%E6%9E%B6%E6%9E%84"><span class="toc-number">10.6.</span> <span class="toc-text">10.5 Supervisor 多代理架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-1-Magentic-One"><span class="toc-number">10.6.1.</span> <span class="toc-text">10.5.1 Magentic-One</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-2-Supervisor-%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">10.6.2.</span> <span class="toc-text">10.5.2 Supervisor 架构介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-6-Multi-Agent%E5%AE%9E%E7%8E%B0%E6%B7%B7%E5%90%88%E5%A4%9A%E7%9F%A5%E8%AF%86%E5%BA%93%E6%A3%80%E7%B4%A2"><span class="toc-number">10.7.</span> <span class="toc-text">10.6 Multi-Agent实现混合多知识库检索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-1-GraphRAG-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">10.7.1.</span> <span class="toc-text">10.6.1 GraphRAG 基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-2-GraphRAG"><span class="toc-number">10.7.2.</span> <span class="toc-text">10.6.2 GraphRAG</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-6-3-%E4%BC%A0%E7%BB%9F-RAG-Agent"><span class="toc-number">10.7.3.</span> <span class="toc-text">10.6.3 传统 RAG Agent</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&text=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&is_video=false&description=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=11.Agent实战技能之LangGraph深度实战&body=Check out this article: http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&title=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&name=11.Agent实战技能之LangGraph深度实战&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/04/01/11.Agent%E5%AE%9E%E6%88%98%E6%8A%80%E8%83%BD%E4%B9%8BLangGraph%E6%B7%B1%E5%BA%A6%E5%AE%9E%E6%88%98/&t=11.Agent实战技能之LangGraph深度实战"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024-2025
    cozy
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/hughnwj">项目</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
